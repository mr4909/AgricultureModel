---
title: "Economic Well-Being in Bagladesh"
author: "Mari Roberts"
date: "4/7/2020"
output: pdf_document
---

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# load necessary packages
requiredPackages = c('foreign', # read dta
                     'dplyr',
                     'haven',
                     'gridExtra',
                     'readr',
                     'dummies',
                     'data.table',
                     'FactoMineR',
                     'factoextra',
                     'ggplot2', # plots
                     'tidyverse') # missing values using map
# only downloads packages if needed
for(p in requiredPackages){
  if(!require(p,character.only = TRUE)) install.packages(p)
  library(p,character.only = TRUE)
}

# set wd
mydirectory <- "/Users/mari/AgricultureModel/Datasets"
setwd(mydirectory)

filenames <- list.files(path=mydirectory, pattern=".*dta")

# read in each dta file
filenames <- list.files(path=mydirectory, pattern=".*dta")
for (i in 1:length(filenames)){
  assign(filenames[i], read_dta(paste("", filenames[i], sep=''))
  )}

# response rates, NAs, counts
# df_counts_NAs <- list.files(path=mydirectory, pattern=".*dta") %>%
#   map(~{
#     read_dta(.x) %>%
#       group_by(hh_ID) %>%
#       summarize_all(.funs = list(count = ~n(), NAs = ~sum(is.na(.))))
#   }) %>%
#   reduce(full_join)
```

# Questions Asked Once

```{r include=FALSE}
####################################################
## Health and Demographics
####################################################

##########################
# Basic Info
##########################

# respondent_info <- Basicinformation.dta %>% select(hh_ID,
#                                                    hh_head, # relationship to head of household
#                                                    religion,
#                                                    age)
# remove outliers for age
# respondent_info <- respondent_info %>% filter(age <= 100)

#209 1 Self
 # 31 2 Spouse
 # 57 3 Child
 # 7  4 Sibling
 # 143 5 Parent

 # 374 1 Muslim
 # 72 2 Hindu
 # 1 4 Buddhist

hh_count <- HouseholdComposition_level_1.dta %>% select(hh_ID, member_1_ID, hh_members) 
# reporting differences between hh_members throughout the year, likely deaths and births?
hh_count <- hh_count %>% distinct(hh_ID, .keep_all = TRUE)

hh_all <- HouseholdComposition_members_level_2.dta %>% mutate(height_meters = tot_height_inch*0.0254,
                                                              canStandOwn = hhm_health1,
                                                              canWalk5Km = hhm_health2,
                                                              canCarry20L = hhm_health3)

# BMI categories
hh_all <- hh_all %>% mutate(bmi = (weight_kg/(height_meters^2)))

# remove outliers for weight and height
hh_all <- hh_all %>% filter(tot_height_inch >= 1 & tot_height_inch <= 100)
hh_all <- hh_all %>% filter(weight_kg >= 1 & weight_kg <= 100)

hh_all <- hh_all %>% mutate(bmiCategory = ifelse(bmi >= 30, "obese", 
                                          ifelse(bmi >=25, "overweight", 
                                          ifelse(bmi >=18.5, "normal", 
                                          ifelse(bmi < 18.5, "underweight", NA)))))

# combine 0 and 77 ("no" and "don't know")
hh_all <- hh_all %>% mutate(canCarry20L = ifelse(canCarry20L==77 | canCarry20L==0, 0, 1),
                            canWalk5Km = ifelse(canWalk5Km==77 | canWalk5Km==0, 0, 1),
                            canStandOwn = ifelse(canStandOwn==77 | canStandOwn==0, 0, 1))

# 0 = male, 1 = female 
# BMI (metric) = 1.3 x weight (kg) / height (m)^2.5
hh_all <- hh_all %>% mutate(sex = ifelse(hhm_sex == 1,0,1)) %>% 
                       select(hh_ID,
                              member_1_ID,
                              hhm_relation,
                              sex,
                              age = hhm_age,
                              maritalStatus = marital_status,
                              literacy,
                              education,
                              attendingCollege = hhm_attending,
                              occupationType = hhm_occu_type,
                              canCarry20L,
                              canWalk5Km,
                              canStandOwn,
                              bmi,
                              bmiCategory)

# factor variables
hh_all$sex = factor(hh_all$sex)
hh_all$maritalStatus = factor(hh_all$maritalStatus)
hh_all$literacy = factor(hh_all$literacy)
hh_all$education = factor(hh_all$education)
hh_all$occupationType = factor(hh_all$occupationType)
hh_all$bmiCategory = factor(hh_all$bmiCategory)

# logical variables
# hh_all$attendingCollege = factor(hh_all$attendingCollege)
# hh_all$canCarry20L = factor(hh_all$canCarry20L)
# hh_all$canWalk5Km = factor(hh_all$canWalk5Km)
# hh_all$canStandOwn = factor(hh_all$canStandOwn)

# does hh have children?
hh_all <- hh_all %>% mutate(isChild = ifelse(age>=18, 0, 1))
hh_children <- hh_all %>% group_by(hh_ID) %>% tally(isChild)
hh_children <- hh_children %>% mutate(numChildren = n) %>% select(hh_ID, numChildren)

# merge
hh_all <- merge(hh_children, hh_all, by = "hh_ID")
  
##########################
# Data by resondents
##########################
hh_respondent <- hh_all %>% filter(hhm_relation == 1)

##########################
# Health by Household
##########################

# count health measures per household
hh_subset <- hh_all %>% select(hh_ID, member_1_ID, bmi, canCarry20L, canWalk5Km, canStandOwn)
          carry <- hh_subset %>% group_by(hh_ID) %>% tally(canCarry20L)
          walk <- hh_subset %>% group_by(hh_ID) %>% tally(canWalk5Km)
          stand <- hh_subset %>% group_by(hh_ID) %>% tally(canStandOwn)

# determine percentage of health measure per household
hh_health <- merge(hh_count, carry, by = "hh_ID") 
hh_health <- merge(hh_health, walk, by = "hh_ID") 
hh_health <- merge(hh_health, stand, by = "hh_ID") 
hh_health <- hh_health %>% select(hh_ID,
                                    member_1_ID,
                                    hh_members,
                                    canCarry20L = n.x,
                                    canWalk5Km = n.y,
                                    canStandOwn = n) %>% 
                             mutate(pctCanCarry20L = canCarry20L/hh_members,
                                    pctCanWalk5Km = canWalk5Km/hh_members,
                                    pctCanStandOwn = canStandOwn/hh_members)

# remove percentages above 100, differences in number of members
hh_health <- hh_health %>% filter(pctCanCarry20L <= 1 &
                                  pctCanWalk5Km <= 1 &
                                  pctCanStandOwn <= 1) %>% select(-canCarry20L,-canWalk5Km,-canStandOwn)

hh_char <- merge(hh_health, hh_children, by = "hh_ID")
hh_char <- hh_char %>% select(-member_1_ID)

# TRUE, if there are no duplicates in hh_ID
length(unique(hh_char$hh_ID)) == nrow(hh_char)
```

```{r}
####################################################
## Housing Characteristics
####################################################

# housing and sanitation characteristics
housing_all <- `41. HousingandSanitation.dta` 

# 113148 120225 221250 224277 more than one entry
# probably need to figure out how to get rid of these. Max date?????????
# housing_all$hh_ID[duplicated(housing_all$hh_ID)]
# housing_all <- housing_all %>% filter(hh_ID != 113148 &
#                                       hh_ID != 120225 &
#                                       hh_ID != 221250 &
#                                       hh_ID != 224277)

##########
# if there is a hh_ID duplicate, use the first entry
##########
# TRUE, if there are no duplicates in hh_ID
length(unique(housing_all$hh_ID)) == nrow(housing_all)
housing_all$submissiondate <- as.Date(housing_all$submissiondate, "%b %d, %Y")
housing_all <- setDT(housing_all)[housing_all[, .I[which.min(submissiondate)], by=hh_ID]$V1]
housing_all <- housing_all %>% select(-submissiondate)
##########

# respondent input year instead of years old
housing_fix_year <- housing_all %>% arrange(desc(house_old))
housing_fix_year <- head(housing_fix_year, 19)
housing_fix_year <- housing_fix_year %>% select(hh_ID, house_old, today)
housing_fix_year$today <- as.Date(housing_fix_year$today, "%b %d, %Y")
housing_fix_year$submissionyear <- as.numeric(format(housing_fix_year$today,'%Y'))
housing_fix_year<- housing_fix_year %>% mutate(house_age = submissionyear-house_old) %>% select(hh_ID, house_age)

housing_all_not_fix_year <- housing_all %>% filter(hh_ID != 115161 &
                                        hh_ID != 120230 &
                                        hh_ID != 105055 &
                                        hh_ID != 221250 &
                                        hh_ID != 233386 &
                                        hh_ID != 120238 &
                                        hh_ID != 222252 &
                                        hh_ID != 240474 &
                                        hh_ID != 108087 &
                                        hh_ID != 120228 &
                                        hh_ID != 230349 &
                                        hh_ID != 235414 &
                                        hh_ID != 231368 &
                                        hh_ID != 115165 &
                                        hh_ID != 235407 &
                                        hh_ID != 229339 &
                                        hh_ID != 224284 &
                                        hh_ID != 232370) %>% select(hh_ID, house_old)

housing_all_not_fix_year <- housing_all_not_fix_year %>% mutate(house_age = house_old) %>% select(-house_old)
housing_all_years_fixed <- merge(housing_all_not_fix_year, housing_fix_year, by = c("hh_ID"), all=TRUE)
housing_all_years_fixed <- housing_all_years_fixed %>% select(hh_ID, house_age = house_age.x)

housing_all <- housing_all %>% select(-sanitation_1_ID,-expiration_date,
                                      -max_submissions,-task_value,-task_length,-recall,
                                      -recall_length,-crowdsource,-week_number,-start_time,
                                      -end_time, -today, -start_date)

housing_all <- merge(housing_all_years_fixed, housing_all, by = c("hh_ID"))

####################################################
## Latrine and Water
####################################################

latrine_all <- `87. latrineUse.dta` %>% select(hh_ID, submissiondate, use_lat, main_use, count_latrine, pct_open)

##########
# if there is a hh_ID duplicate, use the first entry
##########
latrine_all$submissiondate <- as.Date(latrine_all$submissiondate, "%b %d, %Y")
latrine_all <- setDT(latrine_all)[latrine_all[, .I[which.min(submissiondate)], by=hh_ID]$V1]
latrine_all <- latrine_all %>% select(-submissiondate)
##########

housing_all <- merge(latrine_all, housing_all, by = c("hh_ID"))

housing_all$hh_ID[duplicated(housing_all$hh_ID)]

####################################################
## Non-agricultural enterprise
####################################################

# Anyone in household owned/operated any business in 12 months?
nonagricultural_enterprise <- `57. NonAgriculturalEnterprise_level_1.dta` %>% select(hh_ID, submissiondate, business)

##########
# if there is a hh_ID duplicate, use the first entry
##########
nonagricultural_enterprise$submissiondate <- as.Date(nonagricultural_enterprise$submissiondate, "%b %d, %Y")
nonagricultural_enterprise <- setDT(nonagricultural_enterprise)[nonagricultural_enterprise[, .I[which.min(submissiondate)], by=hh_ID]$V1]
nonagricultural_enterprise <- nonagricultural_enterprise %>% select(-submissiondate)
##########

# merge with household characteristics
housing_all <- merge(nonagricultural_enterprise, housing_all, by = c("hh_ID"))
housing_all$hh_ID[duplicated(housing_all$hh_ID)]
str(housing_all)

#################
# ordered factor variables
#################

housing_all$pct_open <- factor(housing_all$pct_open, ordered = TRUE)
# What kind of toilet facility do members of your household use most of the time?
housing_all$main_use <- factor(housing_all$main_use, ordered = TRUE)
# house wall, roof, and floor
housing_all$housewall_material <- factor(housing_all$housewall_material, ordered = TRUE)
housing_all$houseroof_material <- factor(housing_all$houseroof_material, ordered = TRUE)
housing_all$housefloor_material <- factor(housing_all$housefloor_material, ordered = TRUE)

####################################################
## Facilities
####################################################

facilities <- `20. Facilities_level_1.dta` %>% select(hh_ID,submissiondate, facilities,fac_count)

# there are too many variations on the types of facilities visited, so change to:
# visits health centers, bazaar, local shops
facilities$visits_healthcenter <- ifelse(grepl("1",facilities$facilities), 1, 0)
facilities$visits_bazaar <- ifelse(grepl("6",facilities$facilities), 1, 0)
facilities$visits_localshop <- ifelse(grepl("5",facilities$facilities), 1, 0)
facilities <- facilities %>% select(-facilities)

##########
# if there is a hh_ID duplicate, use the first entry
##########
facilities$submissiondate <- as.Date(facilities$submissiondate, "%b %d, %Y")
facilities <- setDT(facilities)[facilities[, .I[which.min(submissiondate)], by=hh_ID]$V1]
facilities <- facilities %>% select(-submissiondate)
##########

# merge with household characteristics
housing_all <- merge(facilities, housing_all, by = c("hh_ID"))

housing_all$hh_ID[duplicated(housing_all$hh_ID)]

####################################################
## Plots
####################################################

plots <- Plots_plot_level_2.dta # fix year
temp <- plots_level_1.dta %>% select(hh_ID, submissiondate, plot_1_ID, today) 
plots <- merge(plots, temp, by=c("hh_ID","plot_1_ID"))

plots$today <- format(as.Date(plots$today, format="%b %d, %Y"),"%Y")
plots$yr_acq <- format(as.Date(plots$yr_acq, format="%b %d, %Y"),"%Y")  
plots$today <- as.numeric(plots$today)
plots$yr_acq <- as.numeric(plots$yr_acq)
plots$plot_age <- plots$today - plots$yr_acq 

# too many plot types (change to three types)
plots$plot_type_homestead <- ifelse(grepl("1",plots$plot_type), 1, 0)
temp <- c("2","8")
plots$plot_type_cultivable_land_pond <- ifelse(grepl(paste(temp, collapse = "|"),plots$plot_type), 1, 0)
temp <- c("3","4","5","6","7","9"," ")
plots$plot_type_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$plot_type), 1, 0)

# who_owns - too many factor levels (change to three types)
plots$who_owns_male <- ifelse(grepl("1",plots$who_owns), 1, 0)
plots$who_owns_family <- ifelse(grepl("2",plots$who_owns), 1, 0)
temp <- c("3","4","5","6")
plots$who_owns_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$who_owns), 1, 0)

# who_owns_off - too many factor levels (change to three types)
plots$who_owns_off_male <- ifelse(grepl("1",plots$who_owns_off), 1, 0)
plots$who_owns_off_family <- ifelse(grepl("2",plots$who_owns_off), 1, 0)
temp <- c("3","4","5","6")
plots$who_owns_off_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$who_owns_off), 1, 0)
 
# who_decision - too many factor levels (change to three types)
plots$who_decision_male <- ifelse(grepl("1",plots$who_decision), 1, 0)
plots$who_decision_family <- ifelse(grepl("2",plots$who_decision), 1, 0)
temp <- c("3","4","5","6")
plots$who_decision_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$who_decision), 1, 0)

# who_responsible - not enough responses

# who_dec_spd - too many factor levels (change to three types)
plots$who_dec_spd_male <- ifelse(grepl("1",plots$who_dec_spd), 1, 0)
plots$who_dec_spd_family <- ifelse(grepl("2",plots$who_dec_spd), 1, 0)
temp <- c("3","4","5","6")
plots$who_dec_spd_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$who_dec_spd), 1, 0)

# who_infra - too many factor levels (change to three types)
plots$who_infra_male <- ifelse(grepl("1",plots$who_infra), 1, 0)
plots$who_infra_family <- ifelse(grepl("2",plots$who_infra), 1, 0)
temp <- c("3","4","5","6")
plots$who_infra_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$who_infra), 1, 0)

##########
# if there is a hh_ID duplicate, use the first entry
##########
# 100+ duplicates
plots$hh_ID[duplicated(plots$hh_ID)]
plots$submissiondate <- as.Date(plots$submissiondate, "%b %d, %Y")
plots <- setDT(plots)[plots[, .I[which.min(submissiondate)], by=hh_ID]$V1]
plots <- plots %>% select(-submissiondate)
##########

plots <- plots %>%  select( hh_ID,
                            plot_type_homestead,
                            plot_type_cultivable_land_pond,
                            plot_type_other,
                            size_plot,
                            flood_depth, # wrong units probably
                            dis_from_home,
                            soil_type,
                            cur_opr_status,
                            amt_rec,
                            cur_mv,
                            how_acq,
                            plot_age,
                            plot_use,
                            work_last_seas,
                            # In last 12 months, who decided to build any infrastructure on this plot?
                            who_infra_male,
                            who_infra_family,
                            who_infra_other,
                            # Who uses the plot?  
                            who_owns_male,
                            who_owns_family,
                            who_owns_other,
                            # Who officially owns?
                            who_owns_off_male,
                            who_owns_off_family,
                            who_owns_off_other,
                            # who_decision who takes most decisions regarding type of crop to be planted or fish to be raised?
                            who_decision_male,
                            who_decision_family,
                            who_decision_other,
                            # who decides how to spend revenues generated from crops or fish?
                            who_dec_spd_male,
                            who_dec_spd_family,
                            who_dec_spd_other)

# merge with household characteristics
housing_all <- merge(plots, housing_all, by = c("hh_ID"))
housing_all$hh_ID[duplicated(housing_all$hh_ID)]
```

## Remove nested and NA questions
```{r}
housing_cleaned <- housing_all %>% select(-rent_paid, 
                                          -drinking_source, 
                                          -house_supply_off, 
                                          -house_elec_cost, 
                                          -fuel_source_other,
                                          -drinking_source, 
                                          -water_purify_other, 
                                          -arsenic_check, 
                                          #-water_purpose_other, 
                                          -color_check)

# remove variables with most missing values
housing_cleaned <- housing_cleaned %>% select(-work_last_seas, 
                                              #-who_responsible, 
                                              -housewall_material_other, 
                                              -houseroof_material_other, 
                                              -housefloor_material_other, 
                                              -lighting_source_other, 
                                              -latrine_other, 
                                              -water_other, 
                                              -drinking_other, 
                                              -garbage_other, 
                                              -amt_rec,
                                              -handpump)

# map(housing_cleaned, ~sum(is.na(.)))
# 
# View(housing_cleaned)

hh_data <- merge(housing_cleaned, hh_char, by = "hh_ID")
hh_data$hh_ID[duplicated(hh_data$hh_ID)]
```

```{r}
categorical_variables <- hh_data %>% select(-size_plot, 
                                                    -flood_depth, 
                                                    -dis_from_home, 
                                                    -cur_mv, 
                                                    -plot_age, 
                                                    -count_latrine, 
                                                    -rent_estimate, 
                                                    -house_old,
                                                    -fuel_cost, 
                                                    -lighting_cost, 
                                                    -cell_cost, 
                                                    -cellphone,
                                                    -house_rooms, 
                                                    -house_rooms_sleeping,
                                                    -house_age, 
                                                    -fac_count,
                                                    -numChildren,
                                                    -pctCanCarry20L,
                                                    -pctCanWalk5Km,
                                                    -pctCanStandOwn,
                                                    -hh_members,
                                                    -count_latrine)
continuous_variables <- hh_data %>% select(hh_ID, size_plot, 
                                                    flood_depth, 
                                                    dis_from_home, 
                                                    cur_mv, 
                                                    plot_age, 
                                                    count_latrine, 
                                                    rent_estimate, 
                                                    fuel_cost, 
                                                    lighting_cost, 
                                                    cell_cost, 
                                                    cellphone,
                                                    house_rooms, 
                                                    house_rooms_sleeping,
                                                    house_age, 
                                                    fac_count,
                                                    numChildren,
                                                    pctCanCarry20L,
                                                    pctCanWalk5Km,
                                                    pctCanStandOwn,
                                                    hh_members,
                                                    count_latrine)

continuous_variables1 <- apply(continuous_variables[,2:21], 2, scale)
continuous_variables <- data.frame(continuous_variables1,continuous_variables$hh_ID)
continuous_variables <- continuous_variables %>% mutate(hh_ID = continuous_variables.hh_ID) %>% select(-continuous_variables.hh_ID)

##################################
# factor variables
##################################

# convert variables to factor variables except hh_ID (column 1)
categorical_variables[,2:44] <- lapply(categorical_variables[,2:44], function(x) as.factor(as.character(x)))
str(categorical_variables)
str(continuous_variables)

# merge categorical and continous variables into one dataframe
final_hh_data <- merge(categorical_variables, continuous_variables, by ="hh_ID")
```

# PCA

final_hh_data is standardized and scaled

```{r}
final_hh_data_noNAs <- final_hh_data[complete.cases(final_hh_data),]
str(final_hh_data_noNAs)
# recode
final_hh_data_noNAs <- dummy.data.frame(final_hh_data_noNAs)

# Calculate eigenvalues & eigenvectors
hh.cov <- cov(final_hh_data_noNAs)
hh.eigen <- eigen(hh.cov)
str(hh.eigen)

# Compute PCA
res.pca <- prcomp(final_hh_data_noNAs, scale. = T)

# Visualize eigenvalues (scree plot). Show the percentage of variances explained by each principal component.
fviz_eig(res.pca)
```

Gaph of individuals. Individuals with a similar profile are grouped together.

```{r}
devtools::install_github("kassambara/factoextra")
library("factoextra")

fviz_pca_ind(res.pca,
             col.ind = "cos2", # Color by the quality of representation
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             
             jitter = list(width = 1, height =1))
```

Graph of variables. Positive correlated variables point to the same side of the plot. Negative correlated variables point to opposite sides of the graph.

```{r}
fviz_pca_var(res.pca,
             col.var = "contrib", # Color by contributions to the PC
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE     # Avoid text overlapping
             )
```

Biplot of individuals and variables

```{r}
fviz_pca_biplot(res.pca, repel = TRUE,
                col.var = "#2E9FDF", # Variables color
                col.ind = "#696969"  # Individuals color
                ,show.clust.cent = TRUE)
```