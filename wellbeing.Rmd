---
title: "Economic Well-Being in Bagladesh"
author: "Mari Roberts"
date: "4/7/2020"
output: pdf_document
---

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# load necessary packages
requiredPackages = c('foreign', # read dta
                     'dplyr', # data manipulation
                     'haven',
                     'gridExtra', # data manipulation
                     'readr', # read files
                     'readxl',# read files
                     'dummies', # PCA
                     'lubridate', # data manipulation
                     'data.table', # data manipulation
                     'FactoMineR', # PCA
                     'factoextra', # PCA
                     'psych', # PCA
                     'nFactors', # PCA
                     'lattice', # plots
                     'glmnet', # lasso
                     'caret', # lasso
                     'ggplot2', # plots
                     'tidyverse') # missing values using map
# only downloads packages if needed
for(p in requiredPackages){
  if(!require(p,character.only = TRUE)) install.packages(p)
  library(p,character.only = TRUE)
}

# set wd
mydirectory <- "/Users/mari/AgricultureModel/Datasets"
setwd(mydirectory)

filenames <- list.files(path=mydirectory, pattern=".*dta")

# read in each dta file found in Dataset folder
filenames <- list.files(path=mydirectory, pattern=".*dta")
for (i in 1:length(filenames)){
  assign(filenames[i], read_dta(paste("", filenames[i], sep=''))
  )}

# custom functions
# remove outliers 
outliers <- function(x){
  quantiles <- quantile( x, c(.00, .95 ) )
  x[ x < quantiles[1] ] <- quantiles[1]
  x[ x > quantiles[2] ] <- quantiles[2]
  x
}
```

# Questions Asked Once

```{r include=FALSE}
####################################################
## Health and Demographics
####################################################

##########################
# Basic Info
##########################

# find number of hh members for calculations later
hh_count <- HouseholdComposition_level_1.dta %>% select(hh_ID, member_1_ID, hh_members) 
hh_count <- hh_count %>% distinct(hh_ID, .keep_all = TRUE)

# rename variables
hh_all <- HouseholdComposition_members_level_2.dta %>% mutate(height_meters = tot_height_inch*0.0254,
                                                              canStandOwn = hhm_health1,
                                                              canWalk5Km = hhm_health2,
                                                              canCarry20L = hhm_health3)
# merge with hh_count
hh_all <- merge(hh_count, hh_all, by=c("hh_ID","member_1_ID"))

# remove outliers for weight and height
hh_all <- hh_all %>% filter(tot_height_inch >= 1 & tot_height_inch <= 100)
hh_all <- hh_all %>% filter(weight_kg >= 1 & weight_kg <= 100)

# bmi
hh_all <- hh_all %>% mutate(bmi = (weight_kg/(height_meters^2)))
# remove outliers for bmi
hh_all <- hh_all %>% filter(bmi < 50)


# create BMI categories
hh_all <- hh_all %>% mutate(bmiCategory = ifelse(bmi >= 30, "obese", 
                                          ifelse(bmi >=25 & bmi < 30, "overweight", 
                                          ifelse(bmi >=18.5 & bmi < 25, "normal", 
                                          ifelse(bmi < 18.5, "underweight", NA)))))

# combine 0 and 77 ("no" and "don't know")
hh_all <- hh_all %>% mutate(canCarry20L = ifelse(canCarry20L==77 | canCarry20L==0, 0, 1),
                            canWalk5Km = ifelse(canWalk5Km==77 | canWalk5Km==0, 0, 1),
                            canStandOwn = ifelse(canStandOwn==77 | canStandOwn==0, 0, 1))

# 0 = male, 1 = female 
# select variables
hh_all <- hh_all %>% mutate(sex = ifelse(hhm_sex == 1,0,1),) %>% 
                       select(hh_ID,
                              member_1_ID,
                              member_2_ID,
                              hh_members,
                              currentposition,
                              hhm_relation,
                              sex,
                              age = hhm_age,
                              maritalStatus = marital_status,
                              literacy,
                              education,
                              attendingCollege = hhm_attending,
                              occupationType = hhm_occu_type,
                              #hhm_occupation,
                              canCarry20L,
                              canWalk5Km,
                              canStandOwn,
                              bmi,
                              bmiCategory)

# change into factor variables
hh_all$sex = factor(hh_all$sex)
hh_all$maritalStatus = factor(hh_all$maritalStatus)
hh_all$literacy = factor(hh_all$literacy)
hh_all$education = factor(hh_all$education)
hh_all$attendingCollege = factor(hh_all$attendingCollege)
hh_all$occupationType = factor(hh_all$occupationType)
hh_all$bmiCategory = factor(hh_all$bmiCategory)


# does hh have children?
hh_all <- hh_all %>% mutate(isChild = ifelse(age>=18, 0, 1))
hh_children <- hh_all %>% group_by(hh_ID) %>% tally(isChild)
hh_children <- hh_children %>% mutate(numChildren = n) %>% select(hh_ID, numChildren)

# merge number of children dataset with hh_all
hh_all <- merge(hh_children, hh_all, by = "hh_ID")
# factor variables
hh_all$isChild <- factor(hh_all$isChild)

##########################
# Health by Household
##########################

# create is underweight variable
hh_all <- hh_all %>% mutate(isUnderweight = ifelse(bmi < 18.5, 1, 0))
# create pct or underweight in the household variable
underweight <- hh_all %>% group_by(hh_ID) %>% tally(isUnderweight)
hh_all <- merge(hh_all, underweight, by = "hh_ID")
hh_all <- hh_all %>% mutate(totalUnderweight = n) %>% select(-n)
hh_all <- hh_all %>%mutate(pctUnderweight = totalUnderweight/hh_members) %>% select(-totalUnderweight,-isUnderweight)

# count health measures per household
hh_subset <- hh_all %>% select(hh_ID, member_1_ID, bmi, canCarry20L, canWalk5Km, canStandOwn)
          carry <- hh_subset %>% group_by(hh_ID) %>% tally(canCarry20L)
          walk <- hh_subset %>% group_by(hh_ID) %>% tally(canWalk5Km)
          stand <- hh_subset %>% group_by(hh_ID) %>% tally(canStandOwn)

# determine percentage of health measure per household
hh_health <- merge(hh_all, carry, by = "hh_ID") 
hh_health <- merge(hh_health, walk, by = "hh_ID") 
hh_health <- merge(hh_health, stand, by = "hh_ID") 

hh_health <- hh_health %>% mutate(totalCanCarry20L = n.x,
                                  totalCanWalk5Km = n.y,
                                  totalCanStandOwn = n)

hh_health <- hh_health %>% mutate(pctCanCarry20L = totalCanCarry20L/hh_members,
                                  pctCanWalk5Km = totalCanWalk5Km/hh_members,
                                  pctCanStandOwn = totalCanStandOwn/hh_members) %>% 
                           select(-n.x,-n.y,-n)

# remove percentages above 100, differences in number of members
hh_health <- hh_health %>% filter(pctCanCarry20L <= 1 &
                                  pctCanWalk5Km <= 1 &
                                  pctCanStandOwn <= 1)

# factor variables
hh_all$canCarry20L = factor(hh_all$canCarry20L)
hh_all$canWalk5Km = factor(hh_all$canWalk5Km)
hh_all$canStandOwn = factor(hh_all$canStandOwn)

####################################################
# Respondent info and health of household members
####################################################

# data about respondents
hh_respondent <- hh_health %>% filter(hhm_relation == 1)

# remove variables
hh_respondent <- hh_respondent %>% select(-member_1_ID,
                                          -member_2_ID,
                                          -currentposition,
                                          -hhm_relation)

head(hh_respondent)

####################################################
## Housing Characteristics
####################################################

# housing and sanitation characteristics
housing_all <- `41. HousingandSanitation.dta` 

##########
# if there is a hh_ID duplicate, use the first entry
# question was only supposed to be answered once but some households submitted twice
##########
housing_all$submissiondate <- as.Date(housing_all$submissiondate, "%b %d, %Y")
housing_all <- setDT(housing_all)[housing_all[, .I[which.min(submissiondate)], by=hh_ID]$V1]
housing_all <- housing_all %>% select(-submissiondate)
# TRUE, if there are no duplicates in hh_ID
length(unique(housing_all$hh_ID)) == nrow(housing_all)
##########

# respondent input year instead of years old
# determine house age

housing_fix_year <- housing_all %>% arrange(desc(house_old))
housing_fix_year <- head(housing_fix_year, 19)
housing_fix_year <- housing_fix_year %>% select(hh_ID, house_old, today)
housing_fix_year$today <- as.Date(housing_fix_year$today, "%b %d, %Y")
housing_fix_year$submissionyear <- as.numeric(format(housing_fix_year$today,'%Y'))
housing_fix_year<- housing_fix_year %>% mutate(house_age = submissionyear-house_old) %>% select(hh_ID, house_age)
housing_all_not_fix_year <- housing_all %>% filter(hh_ID != 115161 &
                                        hh_ID != 120230 &
                                        hh_ID != 105055 &
                                        hh_ID != 221250 &
                                        hh_ID != 233386 &
                                        hh_ID != 120238 &
                                        hh_ID != 222252 &
                                        hh_ID != 240474 &
                                        hh_ID != 108087 &
                                        hh_ID != 120228 &
                                        hh_ID != 230349 &
                                        hh_ID != 235414 &
                                        hh_ID != 231368 &
                                        hh_ID != 115165 &
                                        hh_ID != 235407 &
                                        hh_ID != 229339 &
                                        hh_ID != 224284 &
                                        hh_ID != 232370) %>% select(hh_ID, house_old)
housing_all_not_fix_year <- housing_all_not_fix_year %>% mutate(house_age = house_old) %>% select(-house_old)
housing_all_years_fixed <- merge(housing_all_not_fix_year, housing_fix_year, by = c("hh_ID"), all=TRUE)
housing_all_years_fixed <- housing_all_years_fixed %>% select(hh_ID, house_age = house_age.x)

# select variables
housing_all <- housing_all %>% select(-sanitation_1_ID,-expiration_date,
                                      -max_submissions,-task_value,-task_length,-recall,
                                      -recall_length,-crowdsource,-week_number,-start_time,
                                      -end_time, -today, -start_date, -house, -house_old)

# merge datasets
housing_all <- merge(housing_all_years_fixed, housing_all, by = c("hh_ID"))

#############################
# reduce factor levels 
#############################

# water_purify - too many factor levels
housing_all <- housing_all %>% mutate(does_water_purify = ifelse(water_purify==1, 0, 1))

# garbage - too many factor levels
housing_all <- housing_all %>% mutate(garbage_collected = ifelse(garbage==1|garbage==2, 1, 0))

# lighting_source - too many factor levels - What is your main source of lighting fuel?
# housing_all <- housing_all %>% mutate(lighting_source_elec = ifelse(lighting_source==1 | lighting_source==3, 1, 0))
housing_all$lighting_source_type = as.factor(
    ifelse(housing_all$lighting_source %in% c('1'),'electricity',
        ifelse(housing_all$lighting_source %in% c('3'),'solar',
        ifelse(housing_all$lighting_source %in% c('4'),'kerosine','other'))))

# fuel_source - too many factor levels - What is your main source of cooking fuel? 
# fuel	1	Electricity
# fuel	2	Supply gas
# fuel	3	LPG
# fuel	4	Kerosene
# fuel	5	Firewood
# fuel	6	Dried cow dung
# fuel	7	Coal
# fuel	8	Rice bran/saw dust
# fuel	9	Dried leaves
# fuel	10	Other (specify)
housing_all <- housing_all %>% mutate(fuel_source_wood = ifelse(fuel_source==5, 1, 0))


# housing materials - too many factor levels, combine smaller levels
# material	1	Concrete/Brick  
# material	2	Tin/CI Sheet  
# material	3	Wood  
# material	4	Mud  
# material	5	Bamboo  
# material	6	Jute straw  
# material	7	Plastic /Polythene  
# material	8	Cardboard/paper  
# material	9	Golpaata/Palm leaf  
# material	10	Grass/Straw  
# material	11	Other (specify)  

# > table(housing_all$houseroof_material)
#   1   2   3   4   5   6   7 
#   9 238   9   3  73   1   2 

# > table(housing_all$housewall_material)
#   1   2   3   4   5   8 
# 159 115   9   9  42   1 

# > table(housing_all$housefloor_material)
#   1   2   3   4   5  99 
# 113   2   3 212   2   3 

housing_all$housefloor_material = as.factor(
    ifelse(housing_all$housefloor_material %in% c('1'),
        'concrete',
        ifelse(housing_all$housefloor_material %in% c('2','3','5','99'),'other','mud'))
)
housing_all$houseroof_material = as.factor(
    ifelse(housing_all$houseroof_material %in% c('2'), 'tin','other'))

housing_all$housewall_material = as.factor(
    ifelse(housing_all$housewall_material %in% c('1'),
        'concrete',
        ifelse(housing_all$housewall_material %in% c('3','4','5','8'),'other','tin'))
)

# remove variables 
housing_all <- housing_all %>% select(-rent_paid, 
                                          -housewall_material_other,
                                          -housefloor_material_other,
                                          -houseroof_material_other,
                                          -house_supply_off,
                                          -house_elec_cost,
                                          -lighting_source_other,
                                          -lighting_source,
                                          -latrine_other,
                                          -latrine_type,
                                          -drinking_other,
                                          -water_other,
                                          -water_purify,
                                          -water_other_purpose, # not informative
                                          -drinking_source,
                                          -water_purify_other,
                                          -arsenic_check,
                                          -color_check,
                                          -handpump,
                                          -garbage_other,
                                          -garbage,
                                          -fuel_source,
                                          -fuel_source_other)
# check NAs
map(housing_all, ~sum(is.na(.)))

# check data format types
# str(housing_all)

#################
# order factor variables
#################
# house wall, roof, and floor
housing_all$housewall_material <- factor(housing_all$housewall_material, ordered = TRUE,
                                         levels = c("concrete","tin","other"))
housing_all$houseroof_material <- factor(housing_all$houseroof_material, ordered = TRUE,
                                         levels = c("tin","other"))
housing_all$housefloor_material <- factor(housing_all$housefloor_material, ordered = TRUE,
                                          levels = c("concrete","mud","other"))

##########
# factor variables
##########
housing_all$house_elec  <- factor(housing_all$house_elec)
housing_all$water_supply  <- factor(housing_all$water_supply)
housing_all$garbage_collected <- factor(housing_all$garbage_collected)
housing_all$lighting_source_type  <- factor(housing_all$lighting_source_type)
housing_all$does_water_purify <- factor(housing_all$does_water_purify)
housing_all$drinking_source_same <- factor(housing_all$drinking_source_same)
housing_all$fuel_source_wood  <- factor(housing_all$fuel_source_wood)

str(housing_all)
# check for duplicates 
housing_all$hh_ID[duplicated(housing_all$hh_ID)]

####################################################
## Latrine and Water
####################################################

# select variables
latrine_all <- `87. latrineUse.dta` %>% select(hh_ID, submissiondate, use_lat, main_use, count_latrine, pct_open)

# main_use  - too many factor levels (change to flush or no flush)
temp <- c("1","2","3","4","5","6")
latrine_all$main_use_flush <- ifelse(grepl(paste(temp, collapse = "|"),latrine_all$main_use), 1, 0)
latrine_all <- latrine_all %>% select(-main_use)

# pct_open  - too many factor levels (change to defacate or doesn't defacate in public)
latrine_all$defecation_public <- ifelse(grepl("1",latrine_all$pct_open), 1, 0)
latrine_all <- latrine_all %>% select(-pct_open)

# remove outliers for latrine count
latrine_all <- latrine_all %>% filter(count_latrine >= 0 & count_latrine <= 10)

##########
# if there is a hh_ID duplicate, use the first entry
##########
latrine_all$submissiondate <- as.Date(latrine_all$submissiondate, "%b %d, %Y")
latrine_all <- setDT(latrine_all)[latrine_all[, .I[which.min(submissiondate)], by=hh_ID]$V1]
latrine_all <- latrine_all %>% select(-submissiondate)
##########

##########
# factor variables
##########

latrine_all$use_lat <- factor(latrine_all$use_lat)
latrine_all$main_use_flush <- factor(latrine_all$main_use_flush)
latrine_all$defecation_public <- factor(latrine_all$defecation_public)

# check for NAs
# map(latrine_all, ~sum(is.na(.)))

# merge datasets
housing_all <- merge(latrine_all, housing_all, by = c("hh_ID"))
#housing_all$hh_ID[duplicated(housing_all$hh_ID)]

str(housing_all)

# check for duplicates 
housing_all$hh_ID[duplicated(housing_all$hh_ID)]

####################################################
## Non-agricultural enterprise
####################################################

# Anyone in household owned/operated any business in 12 months?
nonagricultural_enterprise <- `57. NonAgriculturalEnterprise_level_1.dta` %>% select(hh_ID, submissiondate, business)

##########
# if there is a hh_ID duplicate, use the first entry
##########
nonagricultural_enterprise$submissiondate <- as.Date(nonagricultural_enterprise$submissiondate, "%b %d, %Y")
nonagricultural_enterprise <- setDT(nonagricultural_enterprise)[nonagricultural_enterprise[, .I[which.min(submissiondate)], by=hh_ID]$V1]
nonagricultural_enterprise <- nonagricultural_enterprise %>% select(-submissiondate)
##########

##########
# factor variables
##########

nonagricultural_enterprise$business <- factor(nonagricultural_enterprise$business)

# merge with household characteristics
housing_all <- merge(nonagricultural_enterprise, housing_all, by = c("hh_ID"))
# housing_all$hh_ID[duplicated(housing_all$hh_ID)]
#str(housing_all)

# check for duplicates 
housing_all$hh_ID[duplicated(housing_all$hh_ID)]

####################################################
## Facilities
####################################################

# import first facilities dataset
facilities <- `20. Facilities_level_1.dta`
# import second facilities dataset
# facilities2 <- `21. Facilities_facility_repeat_level_2.dta`
# # merge datasets
# facilities_all <- merge(facilities, facilities2, by = c("hh_ID","facility_1_ID"))
# clean variables
# facilities_all <- facilities_all %>% select(hh_ID,
#                                             submissiondate,
#                                             facilities_visited = facilities.x,
#                                             facility_info = facilities.y,
#                                             fac_count,
#                                             fac_mode,
#                                             fac_dist,
#                                             time_taken,
#                                             time_units)
# fasc	1	Health center/hospital
# fasc	2	Bus stop
# fasc	3	Main road
# fasc	4	Railway station
# fasc	5	Local shop/shops
# fasc	6	Weekly/periodic bazaar
# fasc	7	Nearest town
# fasc	8	College
# fasc	9	Agricultural office
# fasc	10	Post office
# fasc	11	Bank
# fasc	12	BRAC
# fasc	13	Grameen Bank
# fasc	14	ASA

# # calculate distance to health center (only 200 records)
# healthcenter <- facilities_all %>% filter(facility_info == 6)
# could be useful to calculate avg distance to facility

# there are too many variations on the types of facilities visited, so change to:
# visits health centers, bazaar, local shops
facilities$visits_healthcenter <- ifelse(grepl("1",facilities$facilities), 1, 0)
facilities$visits_bazaar <- ifelse(grepl("6",facilities$facilities), 1, 0)
facilities$visits_localshop <- ifelse(grepl("5",facilities$facilities), 1, 0)

# remove variables
facilities <- facilities %>% select(hh_ID,
                                    fac_count,
                                    submissiondate,
                                    visits_healthcenter,
                                    visits_bazaar,
                                    visits_localshop)

##########
# if there is a hh_ID duplicate, use the first entry
##########
facilities$submissiondate <- as.Date(facilities$submissiondate, "%b %d, %Y")
facilities <- setDT(facilities)[facilities[, .I[which.min(submissiondate)], by=hh_ID]$V1]
facilities <- facilities %>% select(-submissiondate)
##########

##########
# factor variables
##########
facilities$visits_healthcenter <- factor(facilities$visits_healthcenter)
facilities$visits_bazaar <- factor(facilities$visits_bazaar)
facilities$visits_localshop <- factor(facilities$visits_localshop)

# check for duplicates 
facilities$hh_ID[duplicated(facilities$hh_ID)]

# merge with housing data
housing_all <- merge(facilities, housing_all, by = c("hh_ID"))

####################################################
## Farming Plots
####################################################

# merge plot datasets together
plots <- Plots_plot_level_2.dta # fix year
temp <- plots_level_1.dta %>% select(hh_ID, submissiondate, plot_1_ID, today) 
plots <- merge(plots, temp, by=c("hh_ID","plot_1_ID"))

plots$today <- format(as.Date(plots$today, format="%b %d, %Y"),"%Y")
plots$yr_acq <- format(as.Date(plots$yr_acq, format="%b %d, %Y"),"%Y")  
plots$today <- as.numeric(plots$today)
plots$yr_acq <- as.numeric(plots$yr_acq)
plots$plot_age <- plots$today - plots$yr_acq 

########################
# too many plot types (change to three types: homestead, cultivable, other)
########################
# 1	Homestead
# 2	Cultivable/arable land
# 3	Pasture
# 4	Bush/forest
# 5	Waste/non-arable land
# 6	Land in riverbed
# 7	Other residential/commercial plot
# 8	Cultivable Pond
# 9	Derelict Pond

plots$plot_type_homestead <- ifelse(grepl("1",plots$plot_type), 1, 0)
temp <- c("2","8")
plots$plot_type_cultivable_land_pond <- ifelse(grepl(paste(temp, collapse = "|"),plots$plot_type), 1, 0)
temp <- c("3","4","5","6","7","9"," ")
plots$plot_type_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$plot_type), 1, 0)

plots <- plots %>% 
  mutate(plot_type = case_when((plot_type_homestead==1) ~ "homestead",
                              (plot_type_cultivable_land_pond==1) ~ "cultivable",
                              (plot_type_other==1) ~ "other"))
plots <- plots %>% select(-plot_type_homestead,-plot_type_cultivable_land_pond,-plot_type_other)

# has a cultivable plot 
plots <- plots %>% mutate(hasCultivablePlot = ifelse(plot_type == "cultivable",1,0))
temp <- plots %>% group_by(hh_ID) %>% tally(hasCultivablePlot)
plots <- merge(plots, temp, by = "hh_ID")
plots <- plots %>% mutate(totalCultivablePlot = n) %>% select(-n)

# operational status
# cur_opr	1	Fallow
# cur_opr	2	Own operated
# cur_opr	3	Rented/leased in/cash
# cur_opr	4	Rented/leased in/crop share
# cur_opr	5	Mortgaged in
# cur_opr	6	Rented/leased out/cash
# cur_opr	7	Rented/leased out/crop share
# cur_opr	8	Mortgage out
# cur_opr	9	Group leased in with other farmer
# cur_opr	10	Leased out to NGO
# cur_opr	11	Taken from joint owner
# cur_opr	12	Jointly with other owners

 #  1   2   3   4   5   6   7   8   9  11  12 
 # 56 354  17   8  21   6   5   9   4   2   1

# owns a plot
plots <- plots %>% mutate(hasOwnPlot = ifelse(cur_opr_status == 2,1,0))
temp <- plots %>% group_by(hh_ID) %>% tally(hasOwnPlot)
plots <- merge(plots, temp, by = "hh_ID")
plots <- plots %>% mutate(totalOwnPlot = n) %>% select(-n)

# select variables 
plots <- plots %>% select(hh_ID, 
                          totalCultivablePlot,
                          totalOwnPlot)

# remove duplicates
plots <- distinct(plots, hh_ID, .keep_all= TRUE)
plots$hh_ID[duplicated(plots$hh_ID)]
head(plots)

# merge with housing
housing_all <- merge(housing_all, plots, by="hh_ID")


#Don't need info below for now. Information by specific plot. 

# ########################
# # who_owns - too many factor levels (change to three types)
# ########################
# plots$who_owns_male <- ifelse(grepl("1",plots$who_owns), 1, 0)
# plots$who_owns_family <- ifelse(grepl("2",plots$who_owns), 1, 0)
# temp <- c("3","4","5","6")
# plots$who_owns_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$who_owns), 1, 0)
# 
# plots <- plots %>% 
#   mutate(who_owns = case_when((who_owns_male==1) ~ "male",
#                               (who_owns_family==1) ~ "family",
#                               (who_owns_other==1) ~ "other"))
# plots <- plots %>% select(-who_owns_male,-who_owns_family,-who_owns_other)
# 
# ########################
# # who_owns_off - too many factor levels (change to three types)
# ########################
# plots$who_owns_off_male <- ifelse(grepl("1",plots$who_owns_off), 1, 0)
# plots$who_owns_off_family <- ifelse(grepl("2",plots$who_owns_off), 1, 0)
# temp <- c("3","4","5","6")
# plots$who_owns_off_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$who_owns_off), 1, 0)
# 
# plots <- plots %>% 
#   mutate(who_owns_off = case_when((who_owns_off_male==1) ~ "male",
#                               (who_owns_off_family==1) ~ "family",
#                               (who_owns_off_other==1) ~ "other"))
# plots <- plots %>% select(-who_owns_off_male,-who_owns_off_family,-who_owns_off_other)
#  
# ########################
# # who_decision - too many factor levels (change to three types)
# ########################
# plots$who_decision_male <- ifelse(grepl("1",plots$who_decision), 1, 0)
# plots$who_decision_family <- ifelse(grepl("2",plots$who_decision), 1, 0)
# temp <- c("3","4","5","6")
# plots$who_decision_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$who_decision), 1, 0)
# 
# plots <- plots %>% 
#   mutate(who_decision = case_when((who_decision_male==1) ~ "male",
#                               (who_decision_family==1) ~ "family",
#                               (who_decision_other==1) ~ "other"))
# plots <- plots %>% select(-who_decision_male,-who_decision_family,-who_decision_other)
# 
# ########################
# # who_responsible - not enough responses, didn't include
# ########################
# 
# ########################
# # who_dec_spd - too many factor levels (change to three types)
# ########################
# plots$who_dec_spd_male <- ifelse(grepl("1",plots$who_dec_spd), 1, 0)
# plots$who_dec_spd_family <- ifelse(grepl("2",plots$who_dec_spd), 1, 0)
# temp <- c("3","4","5","6")
# plots$who_dec_spd_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$who_dec_spd), 1, 0)
# 
# plots <- plots %>% 
#   mutate(who_dec_spd = case_when((who_dec_spd_male==1) ~ "male",
#                               (who_dec_spd_family==1) ~ "family",
#                               (who_dec_spd_other==1) ~ "other"))
# plots <- plots %>% select(-who_dec_spd_male,-who_dec_spd_family,-who_dec_spd_other)
# 
# ########################
# # who_infra - too many factor levels (change to three types)
# ########################
# plots$who_infra_male <- ifelse(grepl("1",plots$who_infra), 1, 0)
# plots$who_infra_family <- ifelse(grepl("2",plots$who_infra), 1, 0)
# temp <- c("3","4","5","6")
# plots$who_infra_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$who_infra), 1, 0)
# 
# plots <- plots %>% 
#   mutate(who_infra = case_when((who_infra_male==1) ~ "male",
#                               (who_infra_family==1) ~ "family",
#                               (who_infra_other==1) ~ "other"))
# plots <- plots %>% select(-who_infra_male,-who_infra_family,-who_infra_other)
# 
# ########################
# # cur_opr_status - too many factor levels (change to three types)
# ########################
# plots$cur_opr_status_fallow <- ifelse(grepl("1",plots$cur_opr_status), 1, 0)
# plots$cur_opr_status_own <- ifelse(grepl("2",plots$cur_opr_status), 1, 0)
# temp <- c("3","4","5","6","7","8","9","11")
# plots$cur_opr_status_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$cur_opr_status), 1, 0)
# 
# plots <- plots %>% 
#   mutate(cur_opr_status = case_when((cur_opr_status_fallow==1) ~ "fallow",
#                               (cur_opr_status_own==1) ~ "own",
#                               (cur_opr_status_other==1) ~ "other"))
# plots <- plots %>% select(-cur_opr_status_fallow,-cur_opr_status_own,-cur_opr_status_other)
# 
# ########################
# # how_acq  - too many factor levels (change to three types)
# ########################
# plots$how_acq_bought <- ifelse(grepl("1",plots$how_acq), 1, 0)
# plots$how_acq_inherited <- ifelse(grepl("2",plots$how_acq), 1, 0)
# temp <- c("3","4","5","6")
# plots$how_acq_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$how_acq), 1, 0)
# 
# plots <- plots %>% 
#   mutate(how_acq = case_when((how_acq_bought==1) ~ "bought",
#                               (how_acq_inherited==1) ~ "inherited",
#                               (how_acq_other==1) ~ "other"))
# plots <- plots %>% select(-how_acq_bought,-how_acq_inherited,-how_acq_other)
# 
# ########################
# # plot_use  - too many factor levels (change to four types)
# ########################
# plots$plot_use_agriculture <- ifelse(grepl("1",plots$plot_use), 1, 0)
# plots$plot_use_fisheries <- ifelse(grepl("2",plots$plot_use), 1, 0)
# plots$plot_use_livestock <- ifelse(grepl("2",plots$plot_use), 1, 0)
# temp <- c("3","4","5","6","7","99")
# plots$plot_use_other <- ifelse(grepl(paste(temp, collapse = "|"),plots$plot_use), 1, 0)
# 
# plots <- plots %>% 
#   mutate(plot_use = case_when((plot_use_agriculture==1) ~ "agriculture",
#                               (plot_use_fisheries==1) ~ "fisheries",
#                               (plot_use_other==1) ~ "other",
#                               (plot_use_livestock==1) ~ "livestock"))
# plots <- plots %>% select(-plot_use_agriculture,-plot_use_fisheries,-plot_use_livestock,-plot_use_other)
# 
# ###############################
# # flood depth
# # $flood_depth
# # [1] 0
# # 
# # $flood_unit
# # [1] 175
# # too many missing 
# 
# ##########
# # if there is a hh_ID duplicate, use the first entry
# ##########
# # 100+ duplicates
# plots$hh_ID[duplicated(plots$hh_ID)]
# plots$submissiondate <- as.Date(plots$submissiondate, "%b %d, %Y")
# plots <- setDT(plots)[plots[, .I[which.min(submissiondate)], by=hh_ID]$V1]
# plots <- plots %>% select(-submissiondate)
# ##########
# 
# # select final variables
# 
# plots <- plots %>% select(hh_ID,
#                           size_plot,
#                           dis_from_home,
#                           soil_type,
#                           plot_age,
#                           plot_type,
#                           plot_use,
#                           who_owns,
#                           who_owns_off,
#                           who_decision,
#                           who_dec_spd,
#                           who_infra,
#                           cur_opr_status,
#                           cur_mv,
#                           how_acq)
# 
# ##########
# # factor variables
# ##########
# plots$soil_type <- factor(plots$soil_type)
# plots$plot_type <- factor(plots$plot_type)
# plots$plots$plot_use <- factor(plots$plots$plot_use)
# plots$who_owns <- factor(plots$who_owns)
# plots$who_owns_off <- factor(plots$who_owns_off)
# plots$who_decision <- factor(plots$who_decision)
# plots$who_dec_spd <- factor(plots$who_dec_spd)
# plots$who_infra <- factor(plots$who_infra)
# plots$cur_opr_status <- factor(plots$cur_opr_status)
# plots$how_acq <- factor(plots$how_acq)
# 
# # check for NAs
# # map(plots, ~sum(is.na(.)))
# 
# # no duplicates
# plots$hh_ID[duplicated(plots$hh_ID)]


##Subjective Wellbeing and Final HH Dataset

####################################################
# Subjective Wellbeing
####################################################

# # Which step of ladder (scale of 0 to 10) do you feel you stand at present?
# wellbeing <- `69. SubjectiveWellbeing.dta` %>% select(hh_ID, submissiondate, recall, week_number,
#                                   g1_satisfied, g2_satisfied, g3_satisfied,
#                                   g4_satisfied, g5_satisfied)
# 
# # find satisfaction average
# wellbeing_avg <- wellbeing %>%
#   group_by(hh_ID) %>%
#   summarise_at(vars(-submissiondate, -recall, -week_number), funs(mean(., na.rm=TRUE)))
# wellbeing_avg <- transform(wellbeing_avg, satisfaction = rowMeans(wellbeing_avg[,-1], na.rm = TRUE))
# 
# wellbeing_avg <- wellbeing_avg %>% select(hh_ID, satisfaction)
# 
# housing_final_data <- merge(housing_all, wellbeing_avg, by = "hh_ID")

##################################################################################################################
# FINAL DATAFRAME
##################################################################################################################
# merge with respondent info
final_df <- merge(housing_all, hh_respondent, by="hh_ID")

# remove unnecessary variables
final_df <- final_df %>% select(-totalCanCarry20L,-totalCanStandOwn,-totalCanWalk5Km)

# remove missing values
final_df <- final_df[complete.cases(final_df),]
###############################################################################################################

###############################################################################################################
```

# Food Diary
```{r}
# Which of the following groups of foods were consumed by members of your household in the last ${recall_length} hours?
# Scroll carefully down the list and select all that apply.

# select noncrowdsourced data
fooddiary_1 <- `33.FoodDiary_level_1.dta` %>% filter(crowdsource==0)
fooddiary_1 <- `33.FoodDiary_level_1.dta` %>% filter(recall=="week")

# select variables
fooddiary_1 <- fooddiary_1 %>% select(hh_ID, 
                                      food_1_ID,
                                      submissiondate, 
                                      recall, # month 516 season 272 week 4944
                                      week_number, #3:50 weeks
                                      # gender, 
                                      # age, 
                                      # education, 
                                      # highest_class, 
                                      # relationship, 
                                      food_list, # groups of foods consumed
                                      food_count) # number of foods selected
fooddiary_2 <- `34. FoodDiary_food_level_2.dta` %>% select(hh_ID, 
                                      food_1_ID,
                                      food_2_ID,
                                      food_grp_namec, 
                                      food_type) #will require grepl
fooddiary_3 <- `35. Fooddiary_food_foodtype_level_3.dta` %>% select(hh_ID, 
                                      food_2_ID,
                                      food_3_ID,
                                      food_ID = food_type_name, 
                                      food_type_quant,
                                      food_type_unit,
                                      quant_pur, #How much consumed was purchased?
                                      quant_own, #How much consumed was own production?
                                      quant_other) #How much consumed was from other sources?

# duplicate rows based on food_count - not necessary
# fooddiary_1 <- fooddiary_1[rep(seq(nrow(fooddiary_1)), fooddiary_1$food_count),]

# merge levels 1 and 2
fooddiary_1_2 <- merge(fooddiary_1,fooddiary_2, by=c("hh_ID","food_1_ID"))

# merge with level 3
fooddiary_all <- merge(fooddiary_1_2,fooddiary_3, by=c("hh_ID","food_2_ID"))

# remove unwanted variables
# fooddiary_all <- fooddiary_all %>% select(-food_1_ID,-food_2_ID,-food_3_ID,-food_type)
fooddiary_all <- fooddiary_all %>% select(-food_type) # duplicate variable

# 118 food_type_name are missing
# map(fooddiary_all, ~sum(is.na(.)))
# remove missing values for now.
fooddiary_all <- fooddiary_all[complete.cases(fooddiary_all),]

# *Food Type Unit*
# 9,262 1 Kg
# 8,285 2 Grams
# 205 3 Liter
# 308 4 Milliliter
# 591 5 Tablespoon
# 391 6 Teaspoon
# 208 7 Drops
# 3,088 8 Count

# food names
#rm(list=(ls()[ls()!="fooddiary_all"])) # remove everything from environment except fooddiary_all
food_list <- read_csv("Datasets/food_list.csv")
food_calories <- read_csv("Datasets/food_cal.csv")
food_calories <- food_calories %>% mutate(food_name = food_type)  %>% 
                                   select(-food_type)
food_info <- merge(food_calories, food_list, by="food_name")
# write csv
write.csv(food_info, "food_info.csv")

##############################
# some calories are zero, fix?????????
##############################
# Carbohydrates provide 4 calories per gram, protein provides 4 calories per gram, and fat provides 9 calories per gram
# food_info <- food_info %>% filter(calorie_grams != 0)

# merge with food list names 
fooddiary_cleaned <- merge(food_info, fooddiary_all, by="food_ID")
fooddiary_cleaned <- fooddiary_cleaned %>% select(hh_ID,
                                                  submissiondate,
                                                  recall,
                                                  week_number,
                                                  food_ID,
                                                  food_count,
                                                  food_name,
                                                  food_name_type,
                                                  food_type_quant,
                                                  food_type_unit,
                                                  quant_pur,
                                                  quant_own,
                                                  quant_other,
                                                  food_1_ID,
                                                  food_2_ID,
                                                  food_3_ID)

# percent purchased, grown, other
fooddiary_cleaned <- fooddiary_cleaned %>% mutate(quant_pur_pct = quant_pur/food_type_quant,
                                                  quant_own_pct = quant_own/food_type_quant,
                                                  quant_other_pct = quant_other/food_type_quant)

# merge with food calories/info
fooddiary_cleaned <- merge(fooddiary_cleaned, food_info, by=c("food_ID","food_name_type","food_name"))

# reorder variables
fooddiary_cleaned <- fooddiary_cleaned %>% select(hh_ID,
                                                  submissiondate,
                                                  recall,
                                                  week_number,
                                                  food_ID,
                                                  food_count,
                                                  food_name,
                                                  food_name_type,
                                                  food_type_quant,
                                                  food_type_unit,
                                                  calories_grams,
                                                  quant_pur,
                                                  quant_own,
                                                  quant_other,
                                                  quant_pur_pct,
                                                  quant_own_pct,
                                                  quant_other_pct,
                                                  food_1_ID,
                                                  food_2_ID,
                                                  food_3_ID)

# fix dates and times
fooddiary_cleaned <- fooddiary_cleaned %>%
  mutate(datetime = as.POSIXct(strptime(submissiondate, format = "%b %d, %Y %I:%M:%S %p")),
         datetime_military = strftime(datetime, format = "%Y-%m-%d %H:%M"))

# extract month
fooddiary_cleaned$submission_month <- month(fooddiary_cleaned$datetime)
# extract weekday
fooddiary_cleaned$submission_weekday <- weekdays(fooddiary_cleaned$datetime)
# create breaks

# time of day
# breaks <- hour(hm("00:00", "6:00", "12:00", "18:00", "23:59"))
# # labels for the breaks
# labels <- c("Night", "Morning", "Afternoon", "Evening")
# fooddiary_cleaned$time_of_day <- cut(x=hour(fooddiary_cleaned$datetime), 
#                                      breaks = breaks, 
#                                      labels = labels, include.lowest=TRUE)

# Calculate average caloric intake per person in each household*
# 1	Kg          *1000
# 2	Grams
# 3	Liter       *1000
# 4	Milliliter  /1000  #### fix grams
# 5	Tablespoon  *15
# 6	Teaspoon    *4.2
# 7	Drops       *0.05
# 8	Count

# unit conversions
fooddiary_cleaned <- fooddiary_cleaned %>% 
  mutate(calories_total_grams = case_when((food_type_unit==1) ~ calories_grams*(food_type_quant*1000),
                                          (food_type_unit==2) ~ calories_grams*food_type_quant,
                                          (food_type_unit==3) ~ calories_grams*(food_type_quant*1000),
                                          (food_type_unit==4) ~ calories_grams*(food_type_quant/1000), # fix
                                          (food_type_unit==5) ~ calories_grams*food_type_quant,
                                          (food_type_unit==6) ~ calories_grams*(food_type_quant*4.2),
                                          (food_type_unit==7) ~ calories_grams*(food_type_quant*0.05)))

# rearrange columns
fooddiary_cleaned <- fooddiary_cleaned %>% select(hh_ID,
                                                  submissiondate,
                                                  recall,
                                                  week_number,
                                                  food_ID,
                                                  food_count,
                                                  food_name,
                                                  food_name_type,
                                                  food_type_quant,
                                                  food_type_unit,
                                                  calories_grams,
                                                  calories_total_grams,
                                                  quant_pur,
                                                  quant_own,
                                                  quant_other,
                                                  quant_pur_pct,
                                                  quant_own_pct,
                                                  quant_other_pct,
                                                  datetime,
                                                  datetime_military,
                                                  submission_month,
                                                  submission_weekday,
                                                  #time_of_day,
                                                  food_1_ID,
                                                  food_2_ID,
                                                  food_3_ID)
head(fooddiary_cleaned)

summary(fooddiary_cleaned$calories_total_grams)
```

    Min.  1st Qu.   Median     Mean  3rd Qu.     Max.     NA's 
       0     1200     3000    17994     6000 12000000     2491 
       
## Fix Food Units Claimed As Counts
```{r}

#####################################
# fix food units claimed as "counts"
#####################################
fooddiary_count <- fooddiary_cleaned %>% filter(food_type_unit == 8) %>% arrange(desc(food_name_type))

#########################################
# fix outliers
# If food type quant is more than 100 is meat 
# or fish then change to grams which was likely the intention
# convert to total calories reported in grams
#########################################

fooddiary_count$calories_total_grams = as.numeric(
  
ifelse(fooddiary_count$food_name_type %in% c('fishlarge') & fooddiary_count$food_type_quant > 100, 
       fooddiary_count$calories_grams*fooddiary_count$food_type_quant,
         
         ifelse(fooddiary_count$food_name_type %in% c('fishsmall') & fooddiary_count$food_type_quant > 100, 
                fooddiary_count$calories_grams*fooddiary_count$food_type_quant,
                
                ifelse(fooddiary_count$food_name_type %in% c('meategg') & fooddiary_count$food_type_quant > 100, 
                       fooddiary_count$calories_grams*fooddiary_count$food_type_quant, 
                       
                       # grains (changed to kg)
                       case_when(fooddiary_count$food_name=="Parboiled rice (coarse)" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Fine rice" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Atta" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Non-parboiled rice (coarse)" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Semai/noodles" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Chira (flattened rice)" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Muri/Khoi (puffed rice)" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 # meats (mostly changed to kg)
                                 fooddiary_count$food_name=="Beef/buffalo" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Mutton" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Chicken" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Pigeon" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Fish egg" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant, # egg roe = 1g
                                 fooddiary_count$food_name=="Egg" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*50, # egg = 50g
                                 fooddiary_count$food_name=="Duck" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Stomach of beef/goat" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Dried meat" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Bids/bok/gughu" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Liver" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 # drinks/dairy (can = 340grams/12 fl oz)
                                 fooddiary_count$food_name=="Tea â€“prepared" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*340,
                                 fooddiary_count$food_name=="Coke/ Seven-up etc/Pepci/RC/Urocola etc" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*340,
                                 fooddiary_count$food_name=="Milk" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*340,
                                 fooddiary_count$food_name=="Milk in Tea" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*340,
                                 fooddiary_count$food_name=="Powdered Milk" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*35,# serving of powdered milk
                                 fooddiary_count$food_name=="Condensed Milk" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*340,
                                 fooddiary_count$food_name=="Butter" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*113, # serving of butter
                                 fooddiary_count$food_name=="Yogurt" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*340,
                                 fooddiary_count$food_name=="Cottage cheese or Paneer" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*340, 
                                 fooddiary_count$food_name=="Buttermilk" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*340, 
                                 fooddiary_count$food_name=="Solid Cheese Curds" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*340, 
                                 fooddiary_count$food_name=="Ice Cream" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*340,
                                 fooddiary_count$food_name=="Ice cream" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*340,
                                 # fish small (avg  serving size 170)
                                 # some gura mach in 500 for quantity.....fix later???????
                                 fooddiary_count$food_name=="Gura mach" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*170,
                                 fooddiary_count$food_name=="Panch mishali" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*170,
                                 fooddiary_count$food_name=="Palshe" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*170,
                                 fooddiary_count$food_name=="Tatkeni" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*170,
                                 fooddiary_count$food_name=="Puti" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*170,
                                 fooddiary_count$food_name=="Tengra" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*170,
                                 fooddiary_count$food_name=="Karfu fish" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*170,
                                 fooddiary_count$food_name=="Bata" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*170,
                                 fooddiary_count$food_name=="Kajari" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*170,
                                 fooddiary_count$food_name=="Small prawn" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*3,
                                 fooddiary_count$food_name=="Dried small shrimp/prawn" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*3,
                                 # pulses (avg serving size and average size (nuts))
                                 fooddiary_count$food_name=="Khesari" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*160,
                                 fooddiary_count$food_name=="Dried Lentil" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*160,
                                 fooddiary_count$food_name=="Shem bitchi" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*160,
                                 fooddiary_count$food_name=="Anchor daal" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*160,
                                 fooddiary_count$food_name=="Dried Chick pea" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*160,
                                 fooddiary_count$food_name=="Mung" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*160,
                                 fooddiary_count$food_name=="Black gram" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*160,
                                 fooddiary_count$food_name=="Dried Pea" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*160,
                                 fooddiary_count$food_name=="Groundnut" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Brazilnut" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Cashew Nut" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Almond/Badam" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Hazelnut" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Chestnut" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 # fix vegetables (avg serving size per item)
                                 fooddiary_count$food_name=="Patal" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Okra" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Eggplant" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*141,
                                 fooddiary_count$food_name=="Bitter gourd" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*125,
                                 fooddiary_count$food_name=="Radish" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*4.5,
                                 fooddiary_count$food_name=="Pumpkin" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*5000,
                                 fooddiary_count$food_name=="Green chili" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*45,
                                 fooddiary_count$food_name=="Potato" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*200,
                                 fooddiary_count$food_name=="Sweet potato" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*200,
                                 fooddiary_count$food_name=="Sheem" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100, # broad bean
                                 fooddiary_count$food_name=="Onion" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*150,
                                 fooddiary_count$food_name=="Tomato" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*40,
                                 fooddiary_count$food_name=="Sweet gourd" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*500,
                                 fooddiary_count$food_name=="Garlic" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*13,
                                 fooddiary_count$food_name=="Water gourd" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*145,
                                 fooddiary_count$food_name=="Drum stick" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100, # 26 cal / moringa
                                 fooddiary_count$food_name=="Carrot" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*70,
                                 fooddiary_count$food_name=="Green banana" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*30,
                                 fooddiary_count$food_name=="Cauliflower" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*550,
                                 fooddiary_count$food_name=="Danta (amaranth)" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*45, # 170 cal
                                 fooddiary_count$food_name=="Green Papaya"~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*680,
                                 fooddiary_count$food_name=="Ash gourd" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*8000,
                                 fooddiary_count$food_name=="Cucumber" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*25,
                                 fooddiary_count$food_name=="Kachu (arum)" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100, # 112 cal
                                 fooddiary_count$food_name=="Green mango" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*150,
                                 fooddiary_count$food_name=="Dhundal" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Kachur lati" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Green pea" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*18,
                                 fooddiary_count$food_name=="Green jackfruit" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*7937,
                                 fooddiary_count$food_name=="Mete alu" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*150,
                                 fooddiary_count$food_name=="Kakrol" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100, #spiny gourd
                                 fooddiary_count$food_name=="Soybean bori" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Beher gura" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100, # couldnt find
                                 fooddiary_count$food_name=="Shalgom" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*4.5, # turnip, couldnt find
                                 # fish large (avg large fish calorie count 1000)
                                 fooddiary_count$food_name=="Rui" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Telapia" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Swarputi" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Singi" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Grass Carp" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Taki" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Pangash" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Silver Carp" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Mrigel" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Kalibaus" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Hilsa" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Katla" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Jatka" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Aair" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Boal" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Dried fish" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 fooddiary_count$food_name=="Mirror Carp" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*1000,
                                 # spices (avg calorie count 5)
                                 fooddiary_count$food_name=="Dried chili" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*5,
                                 fooddiary_count$food_name=="Elachi" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*5,
                                 fooddiary_count$food_name=="Cinnamon" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*5,
                                 fooddiary_count$food_name=="Fresh Ginger" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*5,
                                 # other food (average serving size)
                                 fooddiary_count$food_name=="Pitha" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Ruti/Parota" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Singara" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Rice/Jao" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Piaju" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Cake" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Nimki" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Puri" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Alur chap" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Biscuit" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Bonroti/paoroti" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Khichuri" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Polao/Biryani/Tehari" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Chips" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Patties" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Chewing gum" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,                                               
                                 # vegetables (average serving size of 1 cup/128 grams)
                                 fooddiary_count$food_name=="Lal Shak (red amaranth)" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Bathua" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Pat Shak" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Dheki Shak" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Pui (Indian spinach)" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Dhania Shak" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Lau Shak" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Onion/garlic stalk" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Kalmi Shak" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Radish leaves" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Kachu Shak" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Kalo kachu Shak" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Cabbage" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Helencha" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Katanate" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Palang Shak (spinach)" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Pea leaves" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Drumstick leaves" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Mustard leaves" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Mixed leafy vegetables" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Dudhali Pata" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Khesari Shak" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Swett gourd leaves" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Black gram leaves" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Geema Shak" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Neem Shak" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Darkuni Shak" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Bokful" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 fooddiary_count$food_name=="Litchis" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*128,
                                 # oil (serving size 15m)  
                                 fooddiary_count$food_name=="Soybean" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*15,
                                 fooddiary_count$food_name=="Mustard" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*15,
                                 fooddiary_count$food_name=="Dalda/banspati" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*15,
                                 fooddiary_count$food_name=="Red Palm Oil" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*15,
                                 fooddiary_count$food_name=="Ghee" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*15,
                                 fooddiary_count$food_name=="Sesame oil" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*15, 
                                 fooddiary_count$food_name=="Yellow Palm Oil" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*15,
                                 # fruit(avg serving size) 
                                 fooddiary_count$food_name=="Apple" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Mango" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Guava" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Banana" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Lemon" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Karambola" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Grapes" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Dates" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Jujube/dried jujube" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Coconut" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Orange" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Bel" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Tamarind" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Olive" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Chalta" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Pomelo" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Jack Fruit" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Pomelo" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Amra" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Papaya" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Black berry" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Green Coconut" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Dalim" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Tarmuj (Water melon)" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Ata (bullock's heart)" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Bangi (Musk melon)" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Pine apple" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Sobeda" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100,
                                 fooddiary_count$food_name=="Jaamrul" ~ fooddiary_count$calories_grams*fooddiary_count$food_type_quant*100)))))

# view data
head(fooddiary_count)
summary(fooddiary_count$calories_total_grams)
```

Min.   1st Qu.    Median      Mean   3rd Qu.      Max.      NA's 
0.000e+00 7.680e+02 2.000e+03 1.895e+08 6.000e+03 4.701e+11        10 

# Final HH and Food Data
```{r}
# # all records without unit = 8 (counts)
# fooddiary_nocounts <- fooddiary_cleaned %>% filter(food_type_unit != 8) %>% filter(recall=="week")
# 
# calories <- fooddiary_nocounts %>% group_by(hh_ID) %>% tally(calories_total_grams)
# food_entries <- fooddiary_nocounts %>% count(hh_ID)
# temp <- merge(calories, food_entries, by = "hh_ID")
# temp <- temp %>% mutate(hh_calories_total = n.x, hh_food_entries = n.y) %>% select(-n.x,-n.y)
# 
# final_df_food <- merge(final_df, temp, by = "hh_ID")
# 
# final_df_food <- final_df_food %>%mutate(avg_calories = hh_calories_total/hh_food_entries) %>% select(-hh_calories_total,-hh_food_entries)

################################################
# FINAL FOOD DIARY DATAFRAME
# Each food item with calorie info including foods with food type unit = â€œcountâ€.
# removed outliers
################################################
# merge fooddiary_count (unit = 8) and other dataset fooddiary_count to get complete df
fooddiary_nocounts <- fooddiary_cleaned %>% filter(food_type_unit != 8)
fooddiary_all <- rbind(fooddiary_nocounts, fooddiary_count)

# remove missing data 
fooddiary_all <- fooddiary_all[complete.cases(fooddiary_all),]

# remove outliers with custom outliers function (found at top of code)
fooddiary_all$calories_total_grams <- outliers(fooddiary_all$calories_total_grams)

# summary(fooddiary_all$calories_total_grams)
# 
# names(fooddiary_all)

mymonths <- c("Jan","Feb","Mar",
              "Apr","May","Jun",
              "Jul","Aug","Sep",
              "Oct","Nov","Dec")
#add abbreviated month name
fooddiary_all$MonthAbb <- mymonths[fooddiary_all$submission_month]
```

Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
    0.001  1000.000  3000.000  4890.645  6000.000 20000.000
    
## Explore Food Data

```{r fig1, fig.height = 3.5, fig.width = 3.5}
# Food Types Reported by Month
fooddiary_all_week <- fooddiary_all %>% filter(recall=="week")

# jpeg("food_types_reported.jpg") # save jpeg of graph
p1 <- fooddiary_all_week %>%
  filter(recall=="week") %>%
  ggplot(aes(food_name_type)) +
      geom_bar(fill = "darkorchid4") +
      facet_wrap( ~ submission_month, ncol = 4) +
      labs(title = "Food Types Reported by Month",
           subtitle = " ",
           y = "count",
           x = "food group") + theme_bw(base_size = 15)
p1 + theme(axis.text.x = element_text(angle = 60, hjust = 1))
# dev.off()
```

Look for Ramadan and Manga

       cereals          dairy         drinks      fishlarge      fishsmall 
          3435            277            128           1051            857 
        fruits       leafyveg        meategg            oil otherfoodohome 
           590           1469           2021           1262            221 
        pulses         spices     vegetables 
          1430            801           5561 

```{r fig2, fig.height = 3.5, fig.width = 3.5}
# calories of all food types reported by week (shows variation in calories by food type)
# xyplot(
#   calories_total_grams ~ submission_month | food_name_type, 
#   # layout = c(2, 7),               # panel with ncol = 5 and nrow = 3
#   group = food_name_type, data = fooddiary_all_week,
#   type = c("p", "smooth"),        # Show points and smoothed line
#   scales = "free"                 # Make panels axis scales independent
#   )


#https://ipad.fas.usda.gov/cropexplorer/pecad_stories.aspx?regionid=bg&ftype=prodbriefs#:~:text=Bangladesh%20has%20three%20rice%20seasons,and%20harvested%20during%20May%2DJune.

#Bangladesh has three rice seasons, the aus, aman, and boro. The aus season rice crop is planted during March-April and harvested during June-July. The aman season rice is planted in June-July and harvested during November-December. The boro season rice is planted in December-January and harvested during May-June.

############################################
# look at specific food groups reported by week
############################################

# all food groups in one graph

ggplot(fooddiary_all_week, aes(x=week_number, color=food_name_type)) +
  geom_histogram(fill="white", position="dodge")+
  theme(legend.position="top") + 
  labs(title="Foods Reported",x="Week Number", y = "Count")
ggplot(fooddiary_all_week, aes(x=week_number, color=calories_total_grams)) +
  geom_histogram(position="dodge")+
  theme(legend.position="top") + 
  labs(title="Total Calories Reported",x="Week Number", y = "Total Calories")

# separate graphs

meat <- fooddiary_all_week %>% filter(food_name_type == "meategg")
ggplot(meat, aes(x=submission_month, color=food_name_type)) +
  geom_histogram(fill="white", position="dodge")+
  theme(legend.position="top") + 
  labs(title="Meat Reported",x="Week Number", y = "Count") 

cereals <- fooddiary_all_week %>% filter(food_name_type == "cereals")
ggplot(cereals, aes(x=submission_month, color=food_name_type)) +
  geom_histogram(fill="white", position="dodge")+
  theme(legend.position="top") + 
  labs(title="Cereals Reported",x="Week Number", y = "Count")

pulses <- fooddiary_all_week %>% filter(food_name_type == "pulses")
ggplot(pulses, aes(x=submission_month, color=food_name_type)) +
  geom_histogram(fill="white", position="dodge")+
  theme(legend.position="top") + 
  labs(title="Pulses Reported",x="Week Number", y = "Count")

leafyveg <- fooddiary_all_week %>% filter(food_name_type == "leafyveg")
ggplot(leafyveg, aes(x=submission_month, color=food_name_type)) +
  geom_histogram(fill="white", position="dodge")+
  theme(legend.position="top") + 
  labs(title="Leafy Veg Reported",x="Week Number", y = "Count")

fruits <- fooddiary_all_week %>% filter(food_name_type == "fruits")
ggplot(fruits, aes(x=submission_month, color=food_name_type)) +
  geom_histogram(fill="white", position="dodge")+
  theme(legend.position="top") + 
  labs(title="Fruits Reported",x="Week Number", y = "Count")

vegetables <- fooddiary_all_week %>% filter(food_name_type == "vegetables")
ggplot(vegetables, aes(x=submission_month, color=food_name_type)) +
  geom_histogram(fill="white", position="dodge")+
  theme(legend.position="top") + 
  labs(title="Vegetables Reported",x="Week Number", y = "Count")

dairy <- fooddiary_all_week %>% filter(food_name_type == "dairy")
ggplot(dairy, aes(x=submission_month, color=food_name_type)) +
  geom_histogram(fill="white", position="dodge")+
  theme(legend.position="top") + 
  labs(title="Dairy Reported",x="Week Number", y = "Count")
```

## Find avg caloric intake per person in each household

```{r}
############################################
# find average calories by household
############################################
calories <- fooddiary_all %>% filter(recall == "week")
calories <- fooddiary_all %>% group_by(hh_ID, week_number) %>% tally(calories_total_grams)
calories <- calories %>% mutate(hh_calories_total = n) %>% select(-n)

############################################
# find average calories by household member
############################################
# final_df_food <- final_df_food %>%mutate(avg_calories_member = avg_calories/hh_members)
# final_df_food <- final_df_food %>% select(-avg_calories)
# 
# summary(final_df_food$avg_calories_member)

# when merged, there are only 56 observations. Not enough.

############################################
# find average calories by household member with earlier data (basic info only = hh_respondent)
############################################
# df_food <- merge(hh_respondent, temp, by = "hh_ID")
# # remove unnecessary variables
# df_food <- df_food %>% select(-totalCanCarry20L,-totalCanStandOwn,-totalCanWalk5Km)
# # remove missing values
# df_food <- df_food[complete.cases(df_food),]
# # remove duplicates
# df_food <- df_food[!duplicated(df_food$hh_ID), ]
# # avg calories
# df_food <- df_food %>%mutate(avg_calories = hh_calories_total/hh_food_entries) %>% select(-hh_calories_total,-hh_food_entries)
# df_food <- df_food %>%mutate(avg_calories_member = avg_calories/hh_members)
# df_food <- df_food %>% select(-avg_calories)

############################################
# find average calories by household member with hh members count = hh_count
############################################
# df_food_basic <- merge(fooddiary_all, temp, by = "hh_ID")

df_calorie_avg <- merge(calories, hh_count, by = "hh_ID")

df_calorie_avg <- df_calorie_avg %>% mutate(avg_calories_member = hh_calories_total/hh_members) 

# create dataframe for graphs
df_food_basic1 <- df_calorie_avg %>% select(hh_ID, week_number, avg_calories_member)

# remove outliers with custom outliers function (found at top of code)
df_food_basic1$avg_calories_member <- outliers(df_food_basic1$avg_calories_member)

# df_food_basic1 <- df_food_basic1 %>% filter(avg_calories_member >= 0 & avg_calories_member < 16090) # error?
# df_food_basic1 <- df_food_basic1 %>% filter(avg_calories_member != 10000) # error?
# qplot(x=week_number, y=avg_calories_member,
#       data=df_food_basic1, na.rm=TRUE,
#       main="Average Weekly Caloric Intake",
#       xlab="Date", ylab="Calories")

ggplot(df_food_basic1, aes(x = week_number, y = avg_calories_member)) +
    geom_point(aes(color = hh_ID),size = .9) + 
  labs(title = "Average Weekly Caloric Intake", x = "Week Number", y = "Calories")

# Change stripchart colors by groups
p<-ggplot(df_food_basic1, aes(x=avg_calories_member)) 
p+ geom_histogram() + 
  labs(title = "Average Weekly Caloric Intake", x = "Calories", y = "Count")
```

# Gather useful information for economic wellbeing of household

After performing a PCA, the following were the most important factors for the first two components.

maritalStatus, 
occupationType (add attending college), 
education, 
age, 
bmi,
sex (added in addition to PCA)
literacy, 
cellphone,
house_rooms_sleeping, 
housefloor_material, 
house_elec,
housewall_material, 
lighting_source,
defacation_public, 

```{r}
# hh members
hh_count <- HouseholdComposition_level_1.dta %>% select(hh_ID, member_1_ID, hh_members) 
hh_count <- hh_count %>% distinct(hh_ID, .keep_all = TRUE)

# household 
hh1 <- HouseholdComposition_members_level_2.dta %>% mutate(height_meters = tot_height_inch*0.0254)

# merge with hh_count
hh <- merge(hh_count, hh1, by=c("hh_ID","member_1_ID"))

# remove outliers for weight and height
hh <- hh %>% filter(tot_height_inch >= 1 & tot_height_inch <= 100)
hh <- hh %>% filter(weight_kg >= 1 & weight_kg <= 100)

# bmi
hh <- hh %>% mutate(bmi = (weight_kg/(height_meters^2)))
# remove outliers for bmi
hh <- hh %>% filter(bmi < 50)

hh <- hh %>% mutate(sex = ifelse(hhm_sex == 1,0,1)) %>% 
                       select(hh_ID,
                              member_1_ID,
                              member_2_ID,
                              hh_members,
                              currentposition,
                              hhm_relation,
                              sex,
                              age = hhm_age,
                              maritalStatus = marital_status,
                              literacy,
                              education,
                              attendingCollege = hhm_attending,
                              occupationType = hhm_occu_type,
                              bmi)
                              
# change into factor variables
hh$sex = factor(hh$sex)
hh$maritalStatus = factor(hh$maritalStatus)
hh$literacy = factor(hh$literacy)
hh$education = factor(hh$education)
hh$attendingCollege = factor(hh$attendingCollege)
hh$occupationType = factor(hh$occupationType)

####################################################
# Respondent info and household members
####################################################

# data about respondents
hh_respondent <- hh %>% filter(hhm_relation == 1)

# remove variables
hh_respondent <- hh_respondent %>% select(-member_1_ID,
                                          -member_2_ID,
                                          -currentposition,
                                          -hhm_relation)

head(hh_respondent)

# fix attending college
hh_respondent <- hh_respondent %>% 
  mutate(occupation = case_when((occupationType=="farming") ~ "farming",
                              (occupationType=="livestock") ~ "livestock",
                              (occupationType=="nonearning" & attendingCollege==0) ~ "nonearning",
                              (occupationType=="nonearning" & attendingCollege==1) ~ "attendingCollege",
                              (occupationType=="prod") ~ "prod",
                              (occupationType=="salaried") ~ "salaried",
                              (occupationType=="self") ~ "self",
                              (occupationType=="trader") ~ "trader",
                              (occupationType=="wage") ~ "wage",
                              (occupationType=="") ~ "NA"))
hh_respondent <- hh_respondent %>% filter(occupationType != "NA") %>% select(-attendingCollege) # remove NAs
hh_respondent <- hh_respondent %>% select(-occupationType)

########################################
# housing char
########################################

housing <- `41. HousingandSanitation.dta` 

##########
# if there is a hh_ID duplicate, use the first entry
# question was only supposed to be answered once but some households submitted twice
##########
housing$submissiondate <- as.Date(housing$submissiondate, "%b %d, %Y")
housing <- setDT(housing)[housing[, .I[which.min(submissiondate)], by=hh_ID]$V1]
housing <- housing %>% select(-submissiondate)
# TRUE, if there are no duplicates in hh_ID
length(unique(housing$hh_ID)) == nrow(housing)
##########

housing$lighting_source_type = as.factor(
    ifelse(housing$lighting_source %in% c('1'),'electricity',
        ifelse(housing$lighting_source %in% c('3'),'solar',
        ifelse(housing$lighting_source %in% c('4'),'kerosine','other'))))

housing$housefloor_material = as.factor(
    ifelse(housing$housefloor_material %in% c('1'),
        'concrete',
        ifelse(housing$housefloor_material %in% c('2','3','5','99'),'other','mud'))
)
housing$houseroof_material = as.factor(
    ifelse(housing$houseroof_material %in% c('2'), 'tin','other'))

housing$housewall_material = as.factor(
    ifelse(housing$housewall_material %in% c('1'),
        'concrete',
        ifelse(housing$housewall_material %in% c('3','4','5','8'),'other','tin'))
)
housing <- housing %>% select(hh_ID,
                                  house_rooms_sleeping, 
                                  housefloor_material, 
                                  house_elec,
                                  housewall_material)
                                  #lighting_source)

# select variables
# latrine <- `87. latrineUse.dta` %>% select(hh_ID, submissiondate, use_lat, main_use, count_latrine, pct_open)
# # pct_open  - too many factor levels (change to defacate or doesn't defacate in public)
# latrine$defecation_public <- ifelse(grepl("1",latrine$pct_open), 1, 0)
# latrine <- latrine %>% select(hh_ID, defecation_public)
# 
# final_data <- merge(housing, latrine, by = "hh_ID")

# merge with respondent data
final_data <- merge(housing, hh_respondent, by = "hh_ID")
# factor variables
# final_data$defecation_public <- as.factor(final_data$defecation_public)
final_data$house_elec <- as.factor(final_data$house_elec)
# final_data$lighting_source <- as.factor(final_data$lighting_source)
final_data$occupation <- as.factor(final_data$occupation)

##########################################################
# merge with food data (weekly averages per household member)
##########################################################
final_data_food <- merge(final_data, df_food_basic1, by = "hh_ID")

str(final_data_food)

# count number of times a household reported
final_data_food$count <- 1
count <- final_data_food %>% group_by(hh_ID) %>% tally(count)
count <- count %>% mutate(reportCount = n) %>% select(hh_ID, reportCount)
final_data_food <- merge(final_data_food, count, by = "hh_ID")
final_data_food <- final_data_food %>% select(-count)
```

## Clustering
https://www.r-bloggers.com/clustering-mixed-data-types-in-r/
```{r}
# load libraries 
library(cluster)
library(dplyr)
library(ggplot2)
library(readr)
library(Rtsne)

df <- final_data_food %>% select(-avg_calories_member, -week_number, -reportCount)
# remove NAs
df <- na.omit(df)
# check duplicates
df$hh_ID[duplicated(df$hh_ID)]
# remove duplicates
df <- df %>% distinct()
# remove inconsistencies
df <- df %>% filter(hh_ID != 110111 & hh_ID != 230347 & hh_ID != 240476 & hh_ID != "116180")  # 116180 had 70 reports,multple reports per week
# remove hh_ID
df_nohhID <- df %>% select(-hh_ID)


#' Compute Gower distance
gower_dist <- daisy(df_nohhID, metric = "gower")
gower_mat <- as.matrix(gower_dist)

#' Print most similar households
df_nohhID[which(gower_mat == min(gower_mat[gower_mat != min(gower_mat)]), arr.ind = TRUE)[1, ], ]
options(max.print=1000000) # don't let rmd cut off results with max print default

#' Print most dissimilar households
df_nohhID[which(gower_mat == max(gower_mat[gower_mat != max(gower_mat)]), arr.ind = TRUE)[1, ], ]
options(max.print=1000000) # don't let rmd cut off results with max print default

# identify number of clusters (2-8)
sil_width <- c(NA)
for(i in 2:8){  
  pam_fit <- pam(gower_dist, diss = TRUE, k = i)  
  sil_width[i] <- pam_fit$silinfo$avg.width  
}
plot(1:8, sil_width,
     xlab = "Number of clusters",
     ylab = "Silhouette Width")
lines(1:8, sil_width)
```

3 clusters looks good.

Partitioning around medoids (PAM) is an iterative clustering procedure with the following steps:

Choose k random entities to become the medoids
Assign every entity to its closest medoid (using our custom distance matrix in this case)
For each cluster, identify the observation that would yield the lowest average distance if it were to be re-assigned as the medoid. If so, make this observation the new medoid.
If at least one medoid has changed, return to step 2. Otherwise, end the algorithm.
If you know the k-means algorithm, this might look very familiar. In fact, both approaches are identical, except k-means has cluster centers defined by Euclidean distance (i.e., centroids), while cluster centers for PAM are restricted to be the observations themselves (i.e., medoids).

pros: Easy to understand, more robust to noise and outliers when compared to k-means, and has the added benefit of having an observation serve as the exemplar for each cluster

```{r}
k <- 3
pam_fit <- pam(gower_dist, diss = TRUE, k)
pam_results <- df %>%
  mutate(cluster = pam_fit$clustering) %>%
  group_by(cluster) %>%
  do(the_summary = summary(.))
pam_results$the_summary
```

The main differences between the clusters are house wall and floor materials and education.

Another benefit of the PAM algorithm with respect to interpretation is that the medoids serve as exemplars of each cluster.

*Cluster 1: OLDER, MARRIED/UNMARRIED, FARMERS/TRADERS, HOUSING IS CONCRETE*
age 34.27
married
farming/trader
education 2 = some primary or secondary school
housing matrerials are concrete

*Cluster 2: YOUNG, UNMARRIED, ATTENDING COLLEGE, HOUSING NOT CONCRETE*
age = 22.33
unmarried
attending college
education 3 = some college
housing materials are mud or tin

*Cluster 3: OLDER, MARRIED, FARMERS, HOUSING NOT CONCRETE*
age = 35.18
married
farming
education 2 = some primary or secondary school
housing materials are mud or tin/other

```{r}
df[pam_fit$medoids, ]
```

```{r}
tsne_obj <- Rtsne(gower_dist, is_distance = TRUE)

tsne_data <- tsne_obj$Y %>%
  data.frame() %>%
  setNames(c("X", "Y")) %>%
  mutate(cluster = factor(pam_fit$clustering),
         hh_ID = df$hh_ID)

ggplot(aes(x = X, y = Y), data = tsne_data) +
  geom_point(aes(color = cluster))
```

```{r}
# code below can be used to look closer at locations of clusters and compare houses
# tsne_data %>%
#   filter(X > 15 & X < 25,
#          Y > -15 & Y < -10) %>%
#   left_join(df, by = "hh_ID") %>%
#   collect %>%
#   .[["name"]]
```

Compare clusters

```{r}
tsne_data <- merge(tsne_data, count, by = "hh_ID")
cluster1 <- tsne_data %>% filter(cluster == 1) %>% select(hh_ID)
cluster1 <- merge(cluster1, final_data_food, by = "hh_ID")
cluster2 <- tsne_data %>% filter(cluster == 2) %>% select(hh_ID)
cluster2 <- merge(cluster2, final_data_food, by = "hh_ID")
cluster3 <- tsne_data %>% filter(cluster == 3) %>% select(hh_ID)
cluster3 <- merge(cluster3, final_data_food, by = "hh_ID")

tsne_data_clusters <- merge(tsne_data, final_data_food,by = "hh_ID")
tsne_data_clusters <- tsne_data_clusters %>% select(-avg_calories_member, -week_number)
tsne_data_clusters <- tsne_data_clusters %>% distinct()
# function
# foodplot <- function(fooditem, dataf){
# fooditem <- dataf %>% filter(food_name_type == paste(fooditem,sep=""))
# ggplot(fooditem, aes(x=week_number, color=food_name_type)) +
#   geom_histogram(fill="white", position="dodge")+
#   theme(legend.position="top") + 
#   labs(title="Food Reported",x="Week Number", y = "Count")
#   x
# }
# 
# foodplot(vegetables, fooddiary_all_week)

ggplot(cluster1, aes(week_number, avg_calories_member)) +
           geom_point(na.rm=TRUE)

ggplot(cluster2, aes(week_number, avg_calories_member)) +
           geom_point(na.rm=TRUE)

ggplot(cluster3, aes(week_number, avg_calories_member)) +
           geom_point(na.rm=TRUE)

# plot 
p <- ggplot(cluster1, aes(week_number, avg_calories_member)) +
    geom_bar(stat="identity", na.rm = TRUE) +
    ggtitle("Calories Reported by Week") +
    xlab("Week Number") + ylab("Calories Per HH Member") +
    theme(plot.title = element_text(lineheight=.8, face="bold", size = 20)) +
    theme(text = element_text(size=18))
p

p <- ggplot(cluster2, aes(week_number, avg_calories_member)) +
    geom_bar(stat="identity", na.rm = TRUE) +
    ggtitle("Calories Reported by Week") +
    xlab("Week Number") + ylab("Calories Per HH Member") +
    theme(plot.title = element_text(lineheight=.8, face="bold", size = 20)) +
    theme(text = element_text(size=18))
p

p <- ggplot(cluster3, aes(week_number, avg_calories_member)) +
    geom_bar(stat="identity", na.rm = TRUE) +
    ggtitle("Calories Reported by Week") +
    xlab("Week Number") + ylab("Calories Per HH Member") +
    theme(plot.title = element_text(lineheight=.8, face="bold", size = 20)) +
    theme(text = element_text(size=18))
p


# look at one household
temp <- final_data_food %>% filter(hh_ID == 113139)
p <- ggplot(temp, aes(week_number, avg_calories_member)) +
    geom_bar(stat="identity", na.rm = TRUE) +
    ggtitle("Calories Reported for HH 113139 (cluster 1)") +
    xlab("Week Number") + ylab("Calories Per HH Member") +
    theme(plot.title = element_text(lineheight=.8, face="bold", size = 20)) +
    theme(text = element_text(size=18))
p
temp <- final_data_food %>% filter(hh_ID == 225289)
p <- ggplot(temp, aes(week_number, avg_calories_member)) +
    geom_bar(stat="identity", na.rm = TRUE) +
    ggtitle("Calories Reported for HH 225289 (cluster 2)") +
    xlab("Week Number") + ylab("Calories Per HH Member") +
    theme(plot.title = element_text(lineheight=.8, face="bold", size = 20)) +
    theme(text = element_text(size=18))
p
temp <- final_data_food %>% filter(hh_ID == 221249)
p <- ggplot(temp, aes(week_number, avg_calories_member)) +
    geom_bar(stat="identity", na.rm = TRUE) +
    ggtitle("Calories Reported for HH 221249 (cluster 3)") +
    xlab("Week Number") + ylab("Calories Per HH Member") +
    theme(plot.title = element_text(lineheight=.8, face="bold", size = 20)) +
    theme(text = element_text(size=18))
p

# number of times a hh reported calories - compare clusters
# Overlaid histograms
mu <- plyr::ddply(tsne_data_clusters, "cluster", summarise, grp.mean=mean(reportCount))
p<-ggplot(tsne_data_clusters, aes(x=reportCount, color=cluster)) +
  geom_histogram(fill="white", position="dodge")+
  geom_vline(data=mu, aes(xintercept=grp.mean, color=cluster),
             linetype="dashed")+
  theme(legend.position="top")
p
```














# Scale Data
```{r}
df <- final_df

# reorder variables
df <- df %>% select(hh_ID,
                                          visits_healthcenter,
                                          visits_bazaar,
                                          visits_localshop,
                                          business,
                                          #use_lat,
                                          main_use_flush,
                                          defecation_public,
                                          house_sharing,
                                          housewall_material,
                                          houseroof_material,
                                          housefloor_material,
                                          house_elec,
                                          water_supply,
                                          drinking_source_same,
                                          does_water_purify,
                                          garbage_collected,
                                          lighting_source_type,
                                          fuel_source_wood,
                                          sex,
                                          maritalStatus,
                                          literacy,
                                          education,
                                          attendingCollege,
                                          occupationType,
                                          canCarry20L,
                                          canWalk5Km,
                                          canStandOwn,
                                          bmiCategory,
                                          isChild,
                                            #satisfaction,
                                            age,
                                            bmi,
                                            numChildren,
                                            hh_members,
                                            house_age,
                                            rent_estimate,
                                            count_latrine,
                                            house_rooms,
                                            house_rooms_sleeping,
                                            fuel_cost,
                                            lighting_cost,
                                            cellphone,
                                            cell_cost,
                                            fac_count,
                                            pctUnderweight,
                                            pctCanCarry20L,
                                            pctCanWalk5Km,
                                            pctCanStandOwn,
                                            totalCultivablePlot,
                                            totalOwnPlot)

# scale data
df <- df %>% select(-hh_ID)
scale2 <- function(x, na.rm = FALSE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm)
df <- df %>% mutate_if(is.numeric, scale2, na.rm = TRUE)
head(df)
```

# PCA
```{r}
# # recode dummy frame
pca_data <- dummy.data.frame(df)
# 
str(pca_data)

pca_data <- lapply(pca_data, as.numeric)
str(pca_data)

pca_data <- as.data.frame(pca_data)
str(pca_data)
```

## Figure out dimensions of well-being using Factor Analysis

http://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/112-pca-principal-component-analysis-essentials/

```{r}
res.pca <- PCA(pca_data, graph = FALSE)
print(res.pca)
summary(res.pca$eig)

fviz_eig(res.pca, addlabels = TRUE, ylim = c(0, 10))
```

The eigenvalues measure the amount of variation retained by each principal component. Eigenvalues are large for the first PCs and small for the subsequent PCs. That is, the first PCs corresponds to the directions with the maximum amount of variation in the data set.

Examine the eigenvalues to determine the number of principal components to be considered.
```{r}
eig.val <- get_eigenvalue(res.pca)
eig.val

var <- get_pca_var(res.pca)

# Coordinates
head(var$coord)
# Cos2: quality on the factore map
head(var$cos2)
# Contributions to the principal components
head(var$contrib)
```
```{r}
# library("corrplot")
# corrplot(var$cos2, is.corr=FALSE)

# Total cos2 of variables on Dim.1 and Dim.2
fviz_cos2(res.pca, choice = "var", axes = 1:2, top = 10)

# Color by cos2 values: quality on the factor map
fviz_pca_var(res.pca, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE # Avoid text overlapping
             )

# Change the transparency by cos2 values
# fviz_pca_var(res.pca, alpha.var = "cos2")

# head(var$contrib, 4)


# Contributions of variables to PC1
fviz_contrib(res.pca, choice = "var", axes = 1, top = 15)

# Contributions of variables to PC2
fviz_contrib(res.pca, choice = "var", axes = 2, top = 15)
```

```{r}
# total contribution to PC1 and PC2 
fviz_contrib(res.pca, choice = "var", axes = 1:2, top = 10)
```

The most important (or, contributing) variables can be highlighted on the correlation plot as follow:
```{r}
fviz_pca_var(res.pca, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
```

#*Clustering*
```{r}
# Create a grouping variable using kmeans
# Create 3 groups of variables (centers = 3)
set.seed(123)
res.km <- kmeans(var$coord, centers = 3, nstart = 25)
grp <- as.factor(res.km$cluster)
# Color variables by groups
fviz_pca_var(res.pca, col.var = grp, 
             palette = c("#0073C2FF", "#EFC000FF", "#868686FF"),
             legend.title = "Cluster")
```

Identify the most significantly associated variables with a given principal component:
```{r}
res.desc <- dimdesc(res.pca, axes = c(1,2), proba = 0.05)
# Description of dimension 1
res.desc$Dim.1

# Description of dimension 2
res.desc$Dim.2

res.desc
```

```{r}
# results, for individuals
ind <- get_pca_ind(res.pca)
ind
# Coordinates of individuals
head(ind$coord)
# Quality of individuals
head(ind$cos2)
# Contributions of individuals
head(ind$contrib)

fviz_pca_ind(res.pca, col.ind = "cos2", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE # Avoid text overlapping (slow if many points)
             )

fviz_pca_ind(res.pca, pointsize = "cos2", 
             pointshape = 21, fill = "#E7B800",
             repel = TRUE # Avoid text overlapping (slow if many points)
             )
```

```{r}
# Total contribution on PC1 and PC2
fviz_contrib(res.pca, choice = "ind", axes = 1:2)
```

## PCA: Another way

https://rstudio-pubs-static.s3.amazonaws.com/376139_e9adaefdf4594a79a54a3f87ff4852d6.html

```{r}
pca_data <- pca_data[complete.cases(pca_data),]
ev <- eigen(cor(pca_data)) # get eigenvalues
ap <- parallel(subject=nrow(pca_data),var=ncol(pca_data), rep=100, cent=.05)
nS <- nScree(x=ev$values, aparallel=ap$eigen$qevpea)
plotnScree(nS)
parallel<-fa.parallel(pca_data, fm='minres', fa='fa') # 17-29?
```

Optimal factor levels = 18.
Oblique rotation (rotate = â€œobliminâ€) as I believe that there is a correlation in the factors.
Used `Ordinary Least Squared/Minres` factoring (fm = â€œminresâ€), as it is known to provide results similar to `Maximum Likelihood` without assuming a multivariate normal distribution and derives solutions through iterative eigendecomposition like a principal axis.
```{r}
factor3 <- fa(pca_data,nfactors =18,rotate = "oblimin",fm="minres")
# print(factor12)
```

A general rule of thumb is that if the absolute value of the standardized loading is greater than 0.3, the variable is relevant for the particular factor

```{r}
#  consider the loadings more than 0.3 and not loading on more than one factor
# negative values are acceptable
print(factor3$loadings,cutoff = 0.4)
options(max.print=1000000) # don't let rmd cut off results with max print default
```

```{r}
# fa.diagram(factor3)
summary(factor3) # fa(r = pca_data, nfactors = 20, rotate = "oblimin", fm = "minres")

summary(Efa5) # fa(r = pca_data, nfactors = 20, rotate = "oblimin", fm = "minres")
```

The root mean square of residuals (RMSR) is 0.04. This is acceptable as this value should be closer to 0. 

RMSEA (root mean square error of approximation) index. Its value, 0 shows the good model fit as itâ€™s below 0.05. 
Tucker-Lewis Index (TLI) is -0.524 â€“ an acceptable value considering itâ€™s over 0.9.[[[not sure about this because it's negative]]]

## Clustering

Assessing clustering tendency:

To assess the clustering tendency, the Hopkinsâ€™ statistic and a visual approach can be used. This can be performed using the function get_clust_tendency() [factoextra package], which creates an ordered dissimilarity image (ODI).

Hopkins statistic: If the value of Hopkins statistic is close to 1 (far above 0.5), then we can conclude that the dataset is significantly clusterable.
Visual approach: The visual approach detects the clustering tendency by counting the number of square shaped dark (or colored) blocks along the diagonal in the ordered dissimilarity image.
```{r}
gradient.color <- list(low = "steelblue",  high = "white")

pca_data %>%    # Remove column 5 (Species)
  scale() %>%     # Scale variables
  get_clust_tendency(n = 50, gradient = gradient.color)
```

Cluster of households can be seen in the top right corner.

```{r}
# Optimal number of clusters
library("NbClust")
library(factoextra)
res.nbclust <- pca_data %>%
  scale() %>%
  NbClust(distance = "euclidean",
          min.nc = 2, max.nc = 10, 
          method = "complete", index ="all") 
fviz_nbclust(res.nbclust, ggtheme = theme_minimal())
```


```{r}
# Optimal number of clusters for k-means
my_data <- scale(pca_data)
fviz_nbclust(my_data, kmeans, method = "gap_stat")
```
```{r}
# Compute k-means
set.seed(123)
km.res <- kmeans(scale(pca_data), 3, nstart = 25)

# Visualize
fviz_cluster(km.res, data = pca_data,
             palette = c("#00AFBB","#2E9FDF", "#E7B800", "#FC4E07"),
             ggtheme = theme_minimal(),
             main = "Partitioning Clustering Plot"
             )
```

# Factor Analysis: Second Attempt

```{r}
#################################
## Exploratory Factor Analysis ##
#################################

### Step 1: Examining the Correlation Matrix (Supplmental Material Section 1) ###

# An EFA explores the relationship between variables, so it can be useful to examine a correlation matrix of all
# of the possible items to identify what relationships between the items may exist. The code below creates this
# correlation matrix. To account for missing data we chose to build this matrix based on pairwise complete
# observations. Pairwise complete observations uses all pairs available for a correlation, regardless of whether
# or not there are responses to the other observed items. We chose this option because of the small amount of
# missing data in the observed responses (< 5%) and because the analysis is exploratory in nature. Using a
# more complex missing data technique would not necessarily improve the quality of the data for the purposes
# of an exploratory analysis.

# Calculating correlation matrix based on pairwise complete observations
test <- pca_data
efa_cormat <- round(cor(test, use="pairwise.complete.obs"),3)

# Display the correlation matrix

efa_cormat

# The 'corrplot' package re-orders the items and colors the strength of the correlations to make clusters of
# items more apparent.

corrplot((efa_cormat), order = "hclust", tl.col='black', tl.cex=.75)

### Step 2: Determining the number of factors to look for in the EFA (6.6.3) ###

# In an EFA, the user has to specificy how many factors (dimensions) the program should try to model. There
# are multiple methods to do this that return both as visual representations and suggested number of factors
# using multiple tests.

# Visual representation of dimensionality using scree plot and parallel analysis

fa.parallel(test, fm = 'pa')

### Step 3: Specifying the EFA Model (Section 6.6)###

# Below the syntax examines the correlation matrix that we created above. We extract 5 factors, as we wanted
# to examine the most complex solution first. We use an oblimin rotation ("oblimin") that allows our latent factors to be
# correlated, and we also use a principal axis solution ("pa") as our factoring method. The solution is saved to the R
# object "Efa5."

Efa5 <- fa(r = efa_cormat, nfactors = 18,
           rotate = "oblimin", fm = "minres",
           max.iter = 500)
Efa5


print(Efa5$loadings,cutoff = 0.5)
options(max.print=1000000) # don't let rmd cut off results with max print default


```


# Notes
Responses in food diary:
Look over time and identify periods were there were responses
Seasonal access to calories
Mean and variance as access to calories and cluster households
Relatively low caloric variation/or feast vs famine
Disaggregate underreporting and food shortages = income, calories, food groups
Meats grains dairy overtime -- households in this asset are less likely etc.
Meats during the year, or random
Outcome variables?
Pct meat reporting? 
Is someone reporting low, and lower in meat calories than we'd expect
Predict shifts in food types reporting
Differences in these predictions between households?
Fraction of dairy grain meat


# Links
http://wavedatalab.github.io/machinelearningwithr/post4.html
https://datasciencebeginners.com/2018/11/26/functions-and-packages-for-feature-selection-in-r/